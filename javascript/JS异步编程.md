# å¼‚æ­¥ç¼–ç¨‹

**JSé‡‡ç”¨å•çº¿ç¨‹æ¨¡å¼å·¥ä½œçš„åŸå› **

æœ€æ—©jsè¯­è¨€å°±æ˜¯è¿è¡Œåœ¨æµè§ˆå™¨ç«¯çš„è„šæœ¬è¯­è¨€ï¼Œç›®çš„æ˜¯ä¸ºäº†å®ç°é¡µé¢ä¸Šçš„åŠ¨æ€äº¤äº’ã€‚**å®ç°é¡µé¢äº¤äº’çš„æ ¸å¿ƒå°±æ˜¯DOMæ“ä½œï¼Œè¿™å°±å†³å®šäº†å®ƒå¿…é¡»ä½¿ç”¨å•çº¿ç¨‹æ¨¡å‹**ï¼Œå¦åˆ™å°±ä¼šå‡ºç°å¾ˆå¤æ‚çš„çº¿ç¨‹åŒæ­¥é—®é¢˜ã€‚

> å‡è®¾åœ¨jsä¸­æœ‰å¤šä¸ªçº¿ç¨‹ä¸€èµ·å·¥ä½œï¼Œå…¶ä¸­ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹äº†è¿™ä¸ªDOMå…ƒç´ ï¼ŒåŒæ—¶å¦ä¸€ä¸ªçº¿ç¨‹åˆåˆ é™¤äº†è¿™ä¸ªå…ƒç´ ï¼Œæ­¤æ—¶æµè§ˆå™¨å°±æ— æ³•æ˜ç¡®è¯¥ä»¥å“ªä¸ªå·¥ä½œçº¿ç¨‹ä¸ºå‡†ã€‚æ‰€ä»¥ä¸ºäº†é¿å…çº¿ç¨‹åŒæ­¥çš„é—®é¢˜ï¼Œä»ä¸€å¼€å§‹ï¼Œjså°±è®¾è®¡æˆäº†å•çº¿ç¨‹çš„å·¥ä½œæ¨¡å¼ã€‚

å•çº¿ç¨‹æŒ‡çš„æ˜¯ï¼šjsæ‰§è¡Œç¯å¢ƒä¸­è´Ÿè´£æ‰§è¡Œä»£ç çš„çº¿ç¨‹åªæœ‰ä¸€ä¸ª,å¦‚æœæœ‰å¤šä¸ªä»»åŠ¡ï¼Œé‚£ä»»åŠ¡éœ€è¦æ’é˜Ÿä¾æ¬¡æ‰§è¡Œã€‚


**å•çº¿ç¨‹çš„ä¼˜åŠ¿å’Œå¼Šç«¯**

1. ä¼˜åŠ¿ï¼š**æ›´å®‰å…¨ï¼Œæ›´ç®€å•**
2. ç¼ºç‚¹ï¼šå¦‚æœä¸­é—´æœ‰ä¸€ä¸ªç‰¹åˆ«è€—æ—¶çš„ä»»åŠ¡ï¼Œå…¶ä»–çš„ä»»åŠ¡å°±è¦ç­‰å¾…å¾ˆé•¿çš„æ—¶é—´ï¼Œå‡ºç°å‡æ­»çš„æƒ…å†µã€‚**è¿™é‡Œè¦å¼ºè°ƒï¼Œjsæ˜¯å•çº¿ç¨‹çš„ï¼Œæµè§ˆå™¨ä¸æ˜¯å•çº¿ç¨‹çš„ï¼Œæœ‰ä¸€äº›APIæ˜¯æœ‰å•ç‹¬çš„çº¿ç¨‹å»åšçš„ã€‚**

ä¸ºäº†è§£å†³è¿™ç§é—®é¢˜ï¼Œjsæœ‰ä¸¤ç§ä»»åŠ¡çš„æ‰§è¡Œæ¨¡å¼ï¼š**åŒæ­¥æ¨¡å¼ï¼ˆSynchronousï¼‰å’Œå¼‚æ­¥æ¨¡å¼ï¼ˆAsynchronousï¼‰**



## åŒæ­¥æ¨¡å¼ä¸å¼‚æ­¥æ¨¡å¼

### åŒæ­¥æ¨¡å¼ï¼ˆSynchronousï¼‰

> ä»£ç çš„ä»»åŠ¡ä¾æ¬¡æ‰§è¡Œï¼Œåä¸€ä¸ªä»»åŠ¡å¿…é¡»ç­‰å¾…å‰ä¸€ä¸ªä»»åŠ¡ç»“æŸæ‰èƒ½å¼€å§‹æ‰§è¡Œã€‚ç¨‹åºçš„æ‰§è¡Œé¡ºåºå’Œä»£ç çš„ç¼–å†™é¡ºåºæ˜¯å®Œå…¨ä¸€è‡´çš„ã€‚åœ¨å•çº¿ç¨‹æ¨¡å¼ä¸‹ï¼Œå¤§å¤šæ•°ä»»åŠ¡éƒ½ä¼šä»¥åŒæ­¥æ¨¡å¼æ‰§è¡Œ

```js
console.log('global begin')
function bar () {
    console.log('bar task') 
}
function foo () {
    console.log('foo task')
    bar()
}
foo()
console.log('global end')

// global begin
// foo task
// bar task
// global end

// ä½¿ç”¨è°ƒç”¨æ ˆçš„é€»è¾‘
```



### å¼‚æ­¥æ¨¡å¼ï¼ˆAsynchronousï¼‰

> ä¸ä¼šå»ç­‰å¾…è¿™ä¸ªä»»åŠ¡çš„ç»“æŸæ‰å¼€å§‹ä¸‹ä¸€ä¸ªä»»åŠ¡ï¼Œéƒ½æ˜¯å¼€å¯è¿‡åå°±ç«‹å³å¾€åæ‰§è¡Œä¸‹ä¸€ä¸ªä»»åŠ¡ã€‚è€—æ—¶å‡½æ•°çš„åç»­é€»è¾‘ä¼šé€šè¿‡å›è°ƒå‡½æ•°çš„æ–¹å¼å®šä¹‰ã€‚åœ¨å†…éƒ¨ï¼Œè€—æ—¶ä»»åŠ¡å®Œæˆè¿‡åå°±ä¼šè‡ªåŠ¨æ‰§è¡Œä¼ å…¥çš„å›è°ƒå‡½æ•°

jsçº¿ç¨‹æŸä¸ªæ—¶åˆ»å‘èµ·äº†ä¸€ä¸ªå¼‚æ­¥è°ƒç”¨ï¼Œå®ƒç´§æ¥ç€ç»§ç»­æ‰§è¡Œå…¶ä»–çš„ä»»åŠ¡ï¼Œæ­¤æ—¶å¼‚æ­¥çº¿ç¨‹ä¼šå•ç‹¬æ‰§è¡Œå¼‚æ­¥ä»»åŠ¡ï¼Œæ‰§è¡Œè¿‡åä¼šå°†å›è°ƒæ”¾åˆ°æ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼Œjsä¸»çº¿ç¨‹æ‰§è¡Œå®Œä»»åŠ¡è¿‡åä¼šä¾æ¬¡æ‰§è¡Œæ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ã€‚**è¿™é‡Œè¦å¼ºè°ƒï¼Œjsæ˜¯å•çº¿ç¨‹çš„ï¼Œæµè§ˆå™¨ä¸æ˜¯å•çº¿ç¨‹çš„ï¼Œæœ‰ä¸€äº›APIæ˜¯æœ‰å•ç‹¬çš„çº¿ç¨‹å»åšçš„ã€‚**

*è¿™é‡Œçš„åŒæ­¥å’Œå¼‚æ­¥ä¸æ˜¯æŒ‡å†™ä»£ç çš„æ–¹å¼ï¼Œè€Œæ˜¯è¿è¡Œç¯å¢ƒæä¾›çš„APIæ˜¯ä»¥åŒæ­¥æˆ–å¼‚æ­¥æ¨¡å¼çš„æ–¹å¼å·¥ä½œ*

```js
console.log('global begin')
// å»¶æ—¶å™¨
setTimeout(function timer1 () {
    console.log('timer1 invoke')
}, 1800)
// å»¶æ—¶å™¨ä¸­åˆåµŒå¥—äº†ä¸€ä¸ªå»¶æ—¶å™¨
setTimeout(function timer2 () {
    console.log('timer2 invoke')
    setTimeout(function inner () {
        console.log('inner invoke')
    }, 1000)
}, 1000)
console.log('global end')

// global begin
// global end
// timer2 invoke
// timer1 invoke
// inner invoke

// é™¤äº†è°ƒç”¨æ ˆï¼Œè¿˜ç”¨åˆ°äº†æ¶ˆæ¯é˜Ÿåˆ—å’Œäº‹ä»¶å¾ªç¯
/** eventloop è´Ÿè´£ç›‘å¬è°ƒç”¨æ ˆå’Œæ¶ˆæ¯é˜Ÿåˆ—ï¼Œä¸€æ—¦è°ƒç”¨æ ˆä¸­çš„ä»»åŠ¡éƒ½ç»“æŸäº†ï¼Œäº‹ä»¶å¾ªç¯å°±ä¼šä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­å–å‡ºç¬¬ä¸€ä¸ªå›è°ƒå‡½æ•°å‹å…¥åˆ°è°ƒç”¨æ ˆ */
```



### åŒæ­¥æ¨¡å¼APIå’Œå¼‚æ­¥æ¨¡å¼APIçš„ç‰¹ç‚¹

**åŒæ­¥æ¨¡å¼çš„APIçš„ç‰¹ç‚¹:** ä»»åŠ¡æ‰§è¡Œå®Œä»£ç æ‰ä¼šç»§ç»­å¾€ä¸‹èµ°ï¼Œä¾‹å¦‚ï¼šconsole.log

**å¼‚æ­¥æ¨¡å¼çš„APIçš„ç‰¹ç‚¹**: ä¸‹è¾¾è¿™ä¸ªä»»åŠ¡å¼€å¯çš„æŒ‡ä»¤ä¹‹åä»£ç å°±ä¼šç»§ç»­æ‰§è¡Œï¼Œä»£ç ä¸ä¼šç­‰å¾…ä»»åŠ¡çš„ç»“æŸ



## äº‹ä»¶å¾ªç¯ä¸æ¶ˆæ¯é˜Ÿåˆ—

### äº‹ä»¶å¾ªç¯EventLoop

JSæ˜¯å•çº¿ç¨‹ï¼Œåœ¨I/Oæ“ä½œï¼Œç½‘ç»œè¯·æ±‚ï¼Œè¯»å–æ–‡ä»¶ç­‰è¿‡ç¨‹ä¸­éƒ½æ˜¯è¿›è¡Œç­‰å¾…æ“ä½œï¼Œè¿™æ ·å®¹æ˜“å¼•èµ·é˜»å¡ã€‚
JSäº‹ä»¶å¾ªç¯æ˜¯ç”¨æ¥åè°ƒäº‹ä»¶ã€ç”¨æˆ·äº¤äº’ã€è„šæ­¥æ‰§è¡Œã€é¡µé¢æ¸²æŸ“ã€ç½‘ç»œè¯·æ±‚ç­‰ã€‚éƒ½æ˜¯ç”±ä¸€ä¸ªå«åšworkeræœºåˆ¶çš„ä»£ç†å»ç®¡ç†ã€‚
JSå¼•å…¥workeræœºåˆ¶ï¼Œå¯ä»¥å®ç°å¤šçº¿ç¨‹ã€‚workerä¸­è®¾ç½®ä¸¤ä¸ªçº¿ç¨‹ï¼šä¸€ä¸ªè´Ÿè´£ç¨‹åºæœ¬èº«çš„è¿è¡Œï¼Œç§°ä¸ºâ€ä¸»çº¿ç¨‹â€ï¼›å¦ä¸€ä¸ªè´Ÿè´£ä¸»çº¿ç¨‹ä¸å…¶å®ƒè¿›ç¨‹ï¼ˆä¸»è¦æ˜¯å„ç§I/Oæ“ä½œï¼‰çš„é€šä¿¡ï¼Œè¢«ç§°ä¸ºâ€Event Loopçº¿ç¨‹â€, äº‹ä»¶å¾ªç¯è´Ÿè´£æ‰§è¡Œä»£ç ã€æ”¶é›†å’Œå¤„ç†äº‹ä»¶ä»¥åŠæ‰§è¡Œé˜Ÿåˆ—ä¸­çš„å­ä»»åŠ¡ã€‚

*ç®€å•æ¦‚æ‹¬*ï¼š
ä¸»çº¿ç¨‹ä»"ä»»åŠ¡é˜Ÿåˆ—"ä¸­è¯»å–äº‹ä»¶ï¼Œè¿™ä¸ªè¿‡ç¨‹æ˜¯å¾ªç¯ä¸æ–­çš„ï¼Œæ‰€ä»¥æ•´ä¸ªçš„è¿™ç§è¿è¡Œæœºåˆ¶åˆç§°ä¸ºEvent Loopï¼ˆäº‹ä»¶å¾ªç¯ï¼‰ã€‚

Event Loopçº¿ç¨‹å¤„ç†çš„ä»»åŠ¡è¢«åˆ†ä¸ºä¸¤ç±»å³ å¾®ä»»åŠ¡ï¼ˆmicro taskï¼‰å’Œå®ä»»åŠ¡ï¼ˆmacro task)  è¿™ä¸¤ä¸ªä»»åŠ¡åˆ†åˆ«ç»´æŠ¤ä¸€ä¸ªé˜Ÿåˆ—ï¼Œéƒ½æ˜¯é‡‡ç”¨å…ˆè¿›å…ˆå‡ºçš„ç­–ç•¥è¿›è¡Œæ‰§è¡Œã€‚



### æ¶ˆæ¯é˜Ÿåˆ—

ä¸€ä¸ª JavaScript è¿è¡Œæ—¶åŒ…å«äº†ä¸€ä¸ªå¾…å¤„ç†æ¶ˆæ¯çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚æ¯ä¸€ä¸ªæ¶ˆæ¯éƒ½å…³è”ç€ä¸€ä¸ªç”¨ä»¥å¤„ç†è¿™ä¸ªæ¶ˆæ¯çš„å›è°ƒå‡½æ•°ã€‚
åœ¨ *äº‹ä»¶å¾ªç¯* æœŸé—´çš„æŸä¸ªæ—¶åˆ»ï¼Œè¿è¡Œæ—¶ä¼šä»æœ€å…ˆè¿›å…¥é˜Ÿåˆ—çš„æ¶ˆæ¯å¼€å§‹å¤„ç†é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ã€‚è¢«å¤„ç†çš„æ¶ˆæ¯ä¼šè¢«ç§»å‡ºé˜Ÿåˆ—ï¼Œå¹¶ä½œä¸ºè¾“å…¥å‚æ•°æ¥è°ƒç”¨ä¸ä¹‹å…³è”çš„å‡½æ•°ã€‚
æ­£å¦‚å‰é¢æ‰€æåˆ°çš„ï¼Œè°ƒç”¨ä¸€ä¸ªå‡½æ•°æ€»æ˜¯ä¼šä¸ºå…¶åˆ›é€ ä¸€ä¸ªæ–°çš„æ ˆå¸§ã€‚
å‡½æ•°çš„å¤„ç†ä¼šä¸€ç›´è¿›è¡Œåˆ°æ‰§è¡Œæ ˆå†æ¬¡ä¸ºç©ºä¸ºæ­¢ï¼›ç„¶åäº‹ä»¶å¾ªç¯å°†ä¼šå¤„ç†é˜Ÿåˆ—ä¸­çš„ä¸‹ä¸€ä¸ªæ¶ˆæ¯ï¼ˆå¦‚æœè¿˜æœ‰çš„è¯ï¼‰

å½“å‰æ‰§è¡Œæ ˆæ‰§è¡Œå®Œæ¯•æ—¶ä¼šç«‹åˆ»å…ˆå¤„ç†æ‰€æœ‰å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„äº‹ä»¶ï¼Œç„¶åå†å»å®ä»»åŠ¡é˜Ÿåˆ—ä¸­å–å‡ºä¸€ä¸ªäº‹ä»¶ã€‚
åŒä¸€æ¬¡äº‹ä»¶å¾ªç¯ä¸­ï¼Œå¾®ä»»åŠ¡æ°¸è¿œåœ¨å®ä»»åŠ¡ä¹‹å‰æ‰§è¡Œã€‚



### å¾®ä»»åŠ¡/ å®ä»»åŠ¡

**å¸¸è§çš„å®ä»»åŠ¡ï¼š**

- script ä¸­çš„ä»£ç å—
- setTimeout()
- setInterval()
- setImmediate() (éæ ‡å‡†ï¼ŒIE å’Œ Node.js ä¸­æ”¯æŒ)
- æ³¨å†Œäº‹ä»¶

**å¸¸è§çš„å¾®ä»»åŠ¡ï¼š**

- Promise

- [MutationObserver](https://developer.mozilla.org/zh-CN/docs/Web/API/MutationObserver)

- [queueMicrotask](https://developer.mozilla.org/zh-CN/docs/Web/API/WindowOrWorkerGlobalScope/queueMicrotask)()

  ```js
  queueMicrotask(() => {
    console.log('å¾®ä»»åŠ¡')
  })
  ```

**[ä½•æ—¶ä½¿ç”¨å¾®ä»»åŠ¡](https://developer.mozilla.org/zh-CN/docs/Web/API/HTML_DOM_API/Microtask_guide#ä½•æ—¶ä½¿ç”¨å¾®ä»»åŠ¡)**

å¾®ä»»åŠ¡çš„æ‰§è¡Œæ—¶æœºï¼Œæ™šäºå½“å‰æœ¬è½®äº‹ä»¶å¾ªç¯çš„ Call Stack(è°ƒç”¨æ ˆ) ä¸­çš„ä»£ç (å®ä»»åŠ¡)ï¼Œæ—©äºäº‹ä»¶å¤„ç†å‡½æ•°å’Œå®šæ—¶å™¨çš„å›è°ƒå‡½æ•°ã€‚

ä½¿ç”¨å¾®ä»»åŠ¡çš„æœ€ä¸»è¦åŸå› ç®€å•å½’çº³ä¸ºï¼š

- å‡å°‘æ“ä½œä¸­ç”¨æˆ·å¯æ„ŸçŸ¥åˆ°çš„å»¶è¿Ÿ
- ç¡®ä¿ä»»åŠ¡é¡ºåºçš„ä¸€è‡´æ€§ï¼Œå³ä¾¿å½“ç»“æœæˆ–æ•°æ®æ˜¯åŒæ­¥å¯ç”¨çš„
- æ‰¹é‡æ“ä½œçš„ä¼˜åŒ–



**ç¡®ä¿ä»»åŠ¡é¡ºåºçš„ä¸€è‡´æ€§**

```js
customElement.prototype.getData = url => {
  if (this.cache[url]) {
    this.data = this.cache[url];
    this.dispatchEvent(new Event("load"));
  } else {
    fetch(url).then(result => result.arrayBuffer()).then(data => {
      this.cache[url] = data;
      this.data = data;
      this.dispatchEvent(new Event("load"));
    )};
  }
};

element.addEventListener("load", () => console.log("Loaded data"));
console.log("Fetching data...");
element.getData();
console.log("Data fetched");
```

![image-20200622172552236](./images/æ•°æ®è¾“å‡ºç»“æœ.png)

```js
customElement.prototype.getData = url => {
  if (this.cache[url]) {
    queueMicrotask(() => {
      this.data = this.cache[url];
      this.dispatchEvent(new Event("load"));
    });
  } else {
    fetch(url).then(result => result.arrayBuffer()).then(data => {
      this.cache[url] = data;
      this.data = data;
      this.dispatchEvent(new Event("load"));
    )};
  }
};
```

**æ‰¹é‡æ“ä½œ**

```js
let messageQueue = []
let sendMessage = message => {
  messageQueue.push(message)
  if (messageQueue.length === 1) {
    queueMicrotask(() => {
      const json = JSON.stringify(messageQueue);
      messageQueue.length = 0;
      // fetch("url-of-receiver", json);
      console.log(json)
    });
  }
};

sendMessage('åˆ˜å¤‡')
sendMessage('å…³ç¾½')
sendMessage('æ›¹æ“')
```



## å¼‚æ­¥ç¼–ç¨‹çš„å‡ ç§æ–¹å¼

### 1. å›è°ƒå‡½æ•°

> ç”±è°ƒç”¨è€…å®šä¹‰ï¼Œäº¤ç»™æ‰§è¡Œè€…æ‰§è¡Œçš„å‡½æ•°

**ç¼ºç‚¹**ï¼š å¾ˆå®¹æ˜“å½¢æˆå›è°ƒåœ°ç‹±

å›è°ƒå®ç°å¼‚æ­¥ç¼–ç¨‹çš„åœºæ™¯ï¼š

- ajax è¯·æ±‚çš„å›è°ƒ
- å®šæ—¶å™¨ä¸­çš„å›è°ƒ
- äº‹ä»¶å›è°ƒ
- Nodejs ä¸­çš„ä¸€äº›æ–¹æ³•å›è°ƒ

å¼‚æ­¥å›è°ƒå¦‚æœå±‚çº§å¾ˆå°‘ï¼Œå¯è¯»æ€§å’Œä»£ç çš„ç»´æŠ¤æ€§æš‚æ—¶è¿˜æ˜¯å¯ä»¥æ¥å—ï¼Œä¸€æ—¦å±‚çº§å˜å¤šå°±ä¼šé™·å…¥å›è°ƒåœ°ç‹±ï¼Œä¸Šé¢è¿™äº›å¼‚æ­¥ç¼–ç¨‹çš„åœºæ™¯éƒ½ä¼šæ¶‰åŠå›è°ƒåœ°ç‹±çš„é—®é¢˜ã€‚

```js
// callbackå°±æ˜¯å›è°ƒå‡½æ•°
// å°±æ˜¯æŠŠå‡½æ•°ä½œä¸ºå‚æ•°ä¼ é€’ï¼Œç¼ºç‚¹æ˜¯ä¸åˆ©äºé˜…è¯»ï¼Œæ‰§è¡Œé¡ºåºæ··ä¹±ã€‚
function foo(callback) {
    setTimeout(function(){
        callback()
    }, 3000)
}

foo(function() {
    console.log('è¿™å°±æ˜¯ä¸€ä¸ªå›è°ƒå‡½æ•°')
    console.log('è°ƒç”¨è€…å®šä¹‰è¿™ä¸ªå‡½æ•°ï¼Œæ‰§è¡Œè€…æ‰§è¡Œè¿™ä¸ªå‡½æ•°')
    console.log('å…¶å®å°±æ˜¯è°ƒç”¨è€…å‘Šè¯‰æ‰§è¡Œè€…å¼‚æ­¥ä»»åŠ¡ç»“æŸååº”è¯¥åšä»€ä¹ˆ')
})
```



### 2. Promise

> Promiseæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œç”¨æ¥è¡¨è¿°ä¸€ä¸ªå¼‚æ­¥ä»»åŠ¡æ‰§è¡Œä¹‹åæ˜¯æˆåŠŸè¿˜æ˜¯å¤±è´¥ã€‚
> é‡‡ç”¨ Promise çš„å®ç°æ–¹å¼åœ¨ä¸€å®šç¨‹åº¦ä¸Šè§£å†³äº†å›è°ƒåœ°ç‹±çš„é—®é¢˜

å³ä¾¿promiseä¸­æ²¡æœ‰ä»»ä½•çš„å¼‚æ­¥æ“ä½œï¼Œthenæ–¹æ³•çš„å›è°ƒå‡½æ•°ä»ç„¶ä¼šè¿›å…¥åˆ°äº‹ä»¶é˜Ÿåˆ—ä¸­æ’é˜Ÿã€‚

***æœ¬è´¨***ï¼šä½¿ç”¨å›è°ƒå‡½æ•°çš„æ–¹å¼å»å®šä¹‰å¼‚æ­¥ä»»åŠ¡ç»“æŸåæ‰€éœ€è¦æ‰§è¡Œçš„ä»»åŠ¡ã€‚è¿™é‡Œçš„å›è°ƒå‡½æ•°æ˜¯é€šè¿‡thenæ–¹æ³•ä¼ é€’è¿‡å»çš„

ğŸŒ° æ¡ˆä¾‹ï¼šä½¿ç”¨Promiseå»å°è£…ä¸€ä¸ªajaxçš„æ¡ˆä¾‹

```js
function ajax (url) {
  return new Promise((resolve, rejects) => {
    // åˆ›å»ºä¸€ä¸ªXMLHttpRequestå¯¹è±¡å»å‘é€ä¸€ä¸ªè¯·æ±‚
    const xhr = new XMLHttpRequest()
    // å…ˆè®¾ç½®ä¸€ä¸‹xhrå¯¹è±¡çš„è¯·æ±‚æ–¹å¼æ˜¯GETï¼Œè¯·æ±‚çš„åœ°å€å°±æ˜¯å‚æ•°ä¼ é€’çš„url
    xhr.open('GET', url)
    // è®¾ç½®è¿”å›çš„ç±»å‹æ˜¯jsonï¼Œæ˜¯HTML5çš„æ–°ç‰¹æ€§
    // æˆ‘ä»¬åœ¨è¯·æ±‚ä¹‹åæ‹¿åˆ°çš„æ˜¯jsonå¯¹è±¡ï¼Œè€Œä¸æ˜¯å­—ç¬¦ä¸²
    xhr.responseType = 'json'
    // html5ä¸­æä¾›çš„æ–°äº‹ä»¶,è¯·æ±‚å®Œæˆä¹‹åï¼ˆreadyStateä¸º4ï¼‰æ‰ä¼šæ‰§è¡Œ
    xhr.onload = () => {
      if(this.status === 200) {
        // è¯·æ±‚æˆåŠŸå°†è¯·æ±‚ç»“æœè¿”å›
        resolve(this.response)
      } else {
        // è¯·æ±‚å¤±è´¥ï¼Œåˆ›å»ºä¸€ä¸ªé”™è¯¯å¯¹è±¡ï¼Œè¿”å›é”™è¯¯æ–‡æœ¬
        rejects(new Error(this.statusText))
      }
    }
    // å¼€å§‹æ‰§è¡Œå¼‚æ­¥è¯·æ±‚
    xhr.send()
  })
}

ajax('/api/user.json').then((res) => {
  console.log(res)
}, (error) => {
  console.log(error)
})
```



### 3. Generator

> æœ€å¤§çš„ç‰¹ç‚¹å°±æ˜¯å¯ä»¥äº¤å‡ºå‡½æ•°çš„æ‰§è¡Œæƒï¼ŒGenerator å‡½æ•°å¯ä»¥çœ‹å‡ºæ˜¯å¼‚æ­¥ä»»åŠ¡çš„å®¹å™¨ï¼Œéœ€è¦æš‚åœçš„åœ°æ–¹ï¼Œéƒ½ç”¨ yield è¯­æ³•æ¥æ ‡æ³¨ã€‚
> Generator å‡½æ•°ä¸€èˆ¬é…åˆ yield ä½¿ç”¨ï¼ŒGenerator å‡½æ•°æœ€åè¿”å›çš„æ˜¯è¿­ä»£å™¨ã€‚
> å‚è€ƒæ–‡æ¡£ï¼š[è¿­ä»£å™¨å’Œç”Ÿæˆå™¨ - JavaScript | MDN](https://link.zhihu.com/?target=https%3A//developer.mozilla.org/zh-CN/docs/Web/JavaScript/Guide/Iterators_and_Generators)
> å®šä¹‰ç”Ÿæˆå™¨å‡½æ•°å°±æ˜¯åœ¨function åé¢è·Ÿä¸€ä¸ª * 
> Generator å‡½æ•°ä¼šè¿”å›ä¸€ä¸ªç”Ÿæˆå™¨å¯¹è±¡ï¼Œè°ƒç”¨å¯¹è±¡çš„nextæ–¹æ³•æ‰ä¼šå¼€å§‹æ‰§è¡Œå‡½æ•°ä½“å†…å®¹ï¼Œç¢°åˆ°yieldå…³é”®è¯å°±ä¼šæš‚åœæ‰§è¡Œï¼Œyield åé¢çš„å€¼å°†ä¼šä½œä¸ºnext çš„ç»“æœè¿”å›

```js
function * gen() {
  console.log("enter");
  let a = yield 1;
  let b = yield (function () {return 2})();
  return 3;
}
var g = gen()           // é˜»å¡ä½ï¼Œä¸ä¼šæ‰§è¡Œä»»ä½•è¯­å¥
console.log(typeof g)   // è¿”å› object è¿™é‡Œä¸æ˜¯ "function"
console.log(g.next())
console.log(g.next())
console.log(g.next())
console.log(g.next()) 
// output:
// { value: 1, done: false }
// { value: 2, done: false }
// { value: 3, done: true }
// { value: undefined, done: true }
```



### 4. async/await

> async æ˜¯ Generator å‡½æ•°çš„è¯­æ³•ç³–ï¼Œasync/await çš„ä¼˜ç‚¹æ˜¯ä»£ç æ¸…æ™°ï¼ˆä¸åƒä½¿ç”¨ Promise çš„æ—¶å€™éœ€è¦å†™å¾ˆå¤š then çš„æ–¹æ³•é“¾ï¼‰ï¼Œå¯ä»¥å¤„ç†å›è°ƒåœ°ç‹±çš„é—®é¢˜

```js
function testWait() {
    return new Promise((resolve,reject)=>{
        setTimeout(function(){
            console.log("testWait");
            resolve();
        }, 1000);
    })
}
async function testAwaitUse(){
    await testWait()
    console.log("hello");
    return 123;
    // è¾“å‡ºé¡ºåºï¼štestWaitï¼Œhello
    // ç¬¬åè¡Œå¦‚æœä¸ä½¿ç”¨awaitè¾“å‡ºé¡ºåºï¼šhello , testWait
}
console.log(testAwaitUse());
```



### ç›¸å…³æ¨æ–‡

[Promise](../es2015/Promise.md)

[Generator](../es2015/Generator.md)

[async/await](../es2017/async-await.md)



# é™„å½•

- [å¼‚æ­¥ JavaScript](https://developer.mozilla.org/zh-CN/docs/learn/JavaScript/%E5%BC%82%E6%AD%A5)

- [å¹¶å‘æ¨¡å‹ä¸äº‹ä»¶å¾ªç¯](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/EventLoop)

- [Microtasks and the JavaScript runtime environment](https://developer.mozilla.org/zh-CN/docs/Web/API/HTML_DOM_API/Microtask_guide/In_depth)
- [åœ¨ JavaScript ä¸­é€šè¿‡ queueMicrotask() ä½¿ç”¨å¾®ä»»åŠ¡](https://developer.mozilla.org/zh-CN/docs/Web/API/HTML_DOM_API/Microtask_guide)
- [https://developer.mozilla.org/zh-CN/docs/Web/API/HTML_DOM_API/Microtask_guide/In_depth](https://developer.mozilla.org/zh-CN/docs/Web/API/HTML_DOM_API/Microtask_guide/In_depth)
- [Event loops](https://html.spec.whatwg.org/multipage/webappapis.html#event-loops)
