# æ¦‚è¿°

**è‡ªåŠ¨åŒ–æ„å»º**å°±æ˜¯æŒ‡å°†å¼€å‘ä»£ç è‡ªåŠ¨è½¬åŒ–æˆä¸ºç”Ÿäº§ç¯å¢ƒå¯ä»¥è¿è¡Œçš„ä»£ç æˆ–ç¨‹åºã€‚ä¸€èˆ¬æˆ‘ä»¬å°†è¿™æ ·çš„è¿‡ç¨‹ç§°ä¸ºâ€œ**è‡ªåŠ¨åŒ–æ„å»ºå·¥ä½œæµ**â€ã€‚

**ä½œç”¨**ï¼šè®©å¼€å‘äººå‘˜å°½å¯èƒ½è„±ç¦»è¿è¡Œç¯å¢ƒå…¼å®¹æ‰€å¸¦æ¥çš„çš„é—®é¢˜ï¼Œåœ¨å¼€å‘é˜¶æ®µä½¿ç”¨æé«˜æ•ˆç‡çš„è¯­æ³•ã€è§„èŒƒå’Œæ ‡å‡†ã€‚é€šè¿‡è‡ªåŠ¨åŒ–æ„å»ºå·¥å…·ï¼Œå¯ä»¥æ„å»ºè½¬æ¢æµè§ˆå™¨ä¸è¢«æ”¯æŒçš„ç‰¹æ€§ï¼Œæ¯”å¦‚ESæœ€æ–°æ ‡å‡†ã€SCSS ç­‰



# è‡ªåŠ¨åŒ–ä½“éªŒ

> è¯´æ˜ï¼šå…ˆé€šè¿‡CSSè¿›è¡Œæ ·å¼çš„ä¹¦å†™ï¼Œæˆ‘ä»¬å¸Œæœ›èƒ½å¤Ÿé€šè¿‡ SCSS è¿›è¡Œå¯¹ CSS å¢å¼ºã€‚é€šè¿‡åœ¨å¼€å‘æ—¶æ·»åŠ ä¸€ä¸ªæ„å»ºçš„ç¯èŠ‚ï¼Œå°† SCSS æ„å»ºä¸º CSS å³å¯ã€‚

**1. å»ºç«‹ä¸ªäººæµ‹è¯•é¡¹ç›®**

```tex
|-scss
	|- main.scss
|-index.html
|-package.json
```

**2. è½¬æ¢å¼€å‘é˜¶æ®µSCSS**

> æµè§ˆå™¨ä¸æ”¯æŒ SCSS è¯­æ³•ï¼Œæ‰€ä»¥éœ€è¦é€šè¿‡å·¥å…·å°†å…¶è¿›è¡Œè½¬åŒ–

```bash
# å®‰è£…ç›¸åº”ä¾èµ–
yarn add sass --dev
# è¿è¡Œå·¥å…·æŒ‡ä»¤
.\node_modules\.bin\sass scss/main.scss css/style.css
```

ä»¥ä¸Šå‘½ä»¤å¤ªè¿‡å¤æ‚ï¼Œé€šè¿‡ NPM Scripts å°†å…¶ä¼˜åŒ–ä¸€ä¸‹ï¼š

> scripts å¯ä»¥è‡ªåŠ¨å‘ç° node_modules é‡Œé¢çš„å‘½ä»¤

```json
// ä¿®æ”¹ package.json
{
  "scripts": {
    "build": "sass scss/main.scss css/style.css",
    "serve": "browser-sync .",
  },
}
```

```bash
# browser-sync ç”¨æ¥å¯åŠ¨æµ‹è¯•æœåŠ¡å™¨
yarn add browser-sync --dev
```

ä»¥ä¸Šï¼Œè¿è¡Œ `yarn serve` å‘½ä»¤åï¼Œå°±ä¼šè‡ªåŠ¨å¯åŠ¨ä¸€ä¸ªwebæœåŠ¡å™¨å¹¶ä¸”å”¤èµ·æµè§ˆå™¨

**3. ä¼˜åŒ–ç›¸åº”æŒ‡ä»¤**

**3.1 åœ¨é¡µé¢å¯åŠ¨ä¹‹å‰ç”ŸæˆCSSæ–‡ä»¶**

ä½¿ç”¨  NPM Scripts çš„é’©å­æœºåˆ¶ï¼Œæ·»åŠ  `preserve` å‘½ä»¤ã€‚ `preserve` ä¼šåœ¨ serve æ‰§è¡Œä¹‹å‰è¿›è¡Œæ‰§è¡Œã€‚

```json
{
  "scripts": {
    "build": "sass scss/main.scss css/style.css",
    "preserve": "yarn build",
    "serve": "browser-sync .",
  },
}
```

è¿è¡Œ `yarn serve` å‘½ä»¤åï¼Œå°±èƒ½å¾—åˆ°æƒ³è¦çš„æ•ˆæœäº†

**3.2 SCSSæ–‡ä»¶ä¿®æ”¹åè‡ªåŠ¨ç¼–è¯‘ä»£ç **

```bash
# å®‰è£…æ‰€éœ€ä¾èµ–
yarn add npm-run-all --dev
```

```json
// æ·»åŠ  start å‘½ä»¤ï¼šåŒæ—¶æ‰§è¡Œå¤šä¸ªå‘½ä»¤
// --files å¯ä»¥è®©æµè§ˆå™¨å¯åŠ¨åç›‘å¬æ–‡ä»¶çš„ç›¸åº”å˜åŒ–åšå‡ºå“åº”
{
  "scripts": {
    "build": "sass scss/main.scss css/style.css --watch",
    "serve": "browser-sync . --files \"css/*.css\"",
    "start": "run-p build serve"
  },
}
```



# å¸¸ç”¨çš„è‡ªåŠ¨åŒ–æ„å»ºå·¥å…·

- Grunt
  æ’ä»¶ç”Ÿæ€å®Œå–„
  æ„å»ºé€Ÿåº¦ç›¸å¯¹è¾ƒæ…¢ï¼ŒåŸºäºä¸´æ—¶æ–‡ä»¶è¿›è¡Œç£ç›˜è¯»å†™æ“ä½œ
- Gulp
  ç›¸å¯¹Gruntæ„å»ºé€Ÿåº¦è¾ƒå¿«ï¼ŒåŸºäºå†…å­˜è¿›è¡Œæ“ä½œ
  æ”¯æŒåŒæ—¶æ‰§è¡Œå¤šä»»åŠ¡
- FIS
  å¤§è€Œå…¨

## Grunt

### åŸºæœ¬ä½¿ç”¨

```bash
# åˆå§‹åŒ– package.json
yarn init --y
# å®‰è£…ç›¸åº”ä¾èµ–
yarn add grunt
# åˆ›å»ºgruntå…¥å£æ–‡ä»¶
code gruntfile.js
# ä¹¦å†™ gruntfile.js
# è¿è¡Œç›¸åº”å‘½ä»¤ yarn grunt <task name>
yarn grunt foo
```

```js
// gruntfile.js
// Grunt çš„å…¥å£æ–‡ä»¶
// ç”¨äºå®šä¹‰ä¸€äº›éœ€è¦ Grunt è‡ªåŠ¨æ‰§è¡Œçš„ä»»åŠ¡
// éœ€è¦å¯¼å‡ºä¸€ä¸ªå‡½æ•°
// æ­¤å‡½æ•°æ¥æ”¶ä¸€ä¸ª grunt çš„å¯¹è±¡ç±»å‹çš„å½¢å‚
// grunt å¯¹è±¡ä¸­æä¾›ä¸€äº›åˆ›å»ºä»»åŠ¡æ—¶ä¼šç”¨åˆ°çš„ API

module.exports = (grunt) => {
  /**
   * æ³¨å†Œä»»åŠ¡
   * ä»»åŠ¡çš„åå­—
   * ä»»åŠ¡çš„æè¿° | ä»»åŠ¡çš„å‡½æ•° é€šè¿‡ yarn grunt --help åœ¨ Available tasks ä¸­å¯ä»¥çœ‹åˆ°
   */
  grunt.registerTask("foo", "a sample task", () => {
    console.log("hello grunt");
  });

  grunt.registerTask("bar", () => {
    console.log("other task");
  });

  // // default æ˜¯é»˜è®¤ä»»åŠ¡åç§°
  // // é€šè¿‡ grunt æ‰§è¡Œæ—¶å¯ä»¥çœç•¥
  // grunt.registerTask('default', () => {
  //   console.log('default task')
  // })

  // ç¬¬äºŒä¸ªå‚æ•°å¯ä»¥æŒ‡å®šæ­¤ä»»åŠ¡çš„æ˜ å°„ä»»åŠ¡ï¼Œ
  // è¿™æ ·æ‰§è¡Œ default å°±ç›¸å½“äºæ‰§è¡Œå¯¹åº”çš„ä»»åŠ¡
  // è¿™é‡Œæ˜ å°„çš„ä»»åŠ¡ä¼šæŒ‰é¡ºåºä¾æ¬¡æ‰§è¡Œï¼Œä¸ä¼šåŒæ­¥æ‰§è¡Œ
  grunt.registerTask("default", ["foo", "bar"]);

  // ä¹Ÿå¯ä»¥åœ¨ä»»åŠ¡å‡½æ•°ä¸­æ‰§è¡Œå…¶ä»–ä»»åŠ¡
  grunt.registerTask("run-other", () => {
    // foo å’Œ bar ä¼šåœ¨å½“å‰ä»»åŠ¡æ‰§è¡Œå®Œæˆè¿‡åè‡ªåŠ¨ä¾æ¬¡æ‰§è¡Œ
    grunt.task.run("foo", "bar");
    console.log("current task runing~");
  });

  // é»˜è®¤ grunt é‡‡ç”¨åŒæ­¥æ¨¡å¼ç¼–ç 
  // å¦‚æœéœ€è¦å¼‚æ­¥å¯ä»¥ä½¿ç”¨ this.async() æ–¹æ³•åˆ›å»ºå›è°ƒå‡½æ•°
  // grunt.registerTask('async-task', () => {
  //   setTimeout(() => {
  //     console.log('async task working~')
  //   }, 1000)
  // })

  // ç”±äºå‡½æ•°ä½“ä¸­éœ€è¦ä½¿ç”¨ thisï¼Œæ‰€ä»¥è¿™é‡Œä¸èƒ½ä½¿ç”¨ç®­å¤´å‡½æ•°
  grunt.registerTask("async-task", function () {
    const done = this.async();
    setTimeout(() => {
      console.log("async task working~");
      done();
    }, 1000);
  });
};
```

### æ ‡è®°ä»»åŠ¡å¤±è´¥

- å¯ä»¥åœ¨å‡½æ•°ä½“ä¸­`return false` è¿›è¡Œå®ç°
- å¦‚æœå½“å‰ä»»åŠ¡æ˜¯åœ¨ä»»åŠ¡åˆ—è¡¨ä¸­çš„è¯ï¼Œä¼šå¯¼è‡´åç»­ä»»åŠ¡ä¸å†ç»§ç»­æ‰§è¡Œ
- å¼‚æ­¥å‡½æ•°ä¸­æ ‡è®°å½“å‰ä»»åŠ¡æ‰§è¡Œå¤±è´¥çš„æ–¹å¼: ä¸ºå›è°ƒå‡½æ•°æŒ‡å®šä¸€ä¸ª false çš„å®å‚

```js
// gruntfile.js
module.exports = grunt => {
  // ä»»åŠ¡å‡½æ•°æ‰§è¡Œè¿‡ç¨‹ä¸­å¦‚æœè¿”å› false
  // åˆ™æ„å‘³ç€æ­¤ä»»åŠ¡æ‰§è¡Œå¤±è´¥
  grunt.registerTask('bad', () => {
    console.log('bad working~')
    return false
  })

  grunt.registerTask('foo', () => {
    console.log('foo working~')
  })

  grunt.registerTask('bar', () => {
    console.log('bar working~')
  })

  // å¦‚æœä¸€ä¸ªä»»åŠ¡åˆ—è¡¨ä¸­çš„æŸä¸ªä»»åŠ¡æ‰§è¡Œå¤±è´¥
  // åˆ™åç»­ä»»åŠ¡é»˜è®¤ä¸ä¼šè¿è¡Œ
  // é™¤é grunt è¿è¡Œæ—¶æŒ‡å®š --force å‚æ•°å¼ºåˆ¶æ‰§è¡Œ
  grunt.registerTask('default', ['foo', 'bad', 'bar'])

  // å¼‚æ­¥å‡½æ•°ä¸­æ ‡è®°å½“å‰ä»»åŠ¡æ‰§è¡Œå¤±è´¥çš„æ–¹å¼æ˜¯ä¸ºå›è°ƒå‡½æ•°æŒ‡å®šä¸€ä¸ª false çš„å®å‚
  grunt.registerTask('bad-async', function () {
    const done = this.async()
    setTimeout(() => {
      console.log('async task working~')
      done(false)
    }, 1000)
  })
}
```

### é…ç½®é€‰é¡¹æ–¹æ³•

> grunt.initConfig()

```js
// gruntfile.js
module.exports = grunt => {
  // grunt.initConfig() ç”¨äºä¸ºä»»åŠ¡æ·»åŠ ä¸€äº›é…ç½®é€‰é¡¹
  grunt.initConfig({
    // é”®ä¸€èˆ¬å¯¹åº”ä»»åŠ¡çš„åç§°
    // å€¼å¯ä»¥æ˜¯ä»»æ„ç±»å‹çš„æ•°æ®
    foo: {
      bar: 'baz'
    }
  })

  grunt.registerTask('foo', () => {
    // ä»»åŠ¡ä¸­å¯ä»¥ä½¿ç”¨ grunt.config() è·å–é…ç½®
    console.log(grunt.config('foo'))
    // å¦‚æœå±æ€§å€¼æ˜¯å¯¹è±¡çš„è¯ï¼Œconfig ä¸­å¯ä»¥ä½¿ç”¨ç‚¹çš„æ–¹å¼å®šä½å¯¹è±¡ä¸­å±æ€§çš„å€¼
    console.log(grunt.config('foo.bar'))
  })
}
```

### å¤šç›®æ ‡ä»»åŠ¡

å¦‚æœæƒ³è¦è¿è¡ŒæŒ‡å®šçš„ç›®æ ‡ï¼Œå¦‚ä¸‹ç¤ºä¾‹å¯ä»¥ä½¿ç”¨ `yarn grunt build:foo`
åœ¨ build ä¸­æŒ‡å®šçš„æ¯ä¸€ä¸ªé”®éƒ½ä¼šæˆä¸ºä¸€ä¸ªç›®æ ‡ï¼Œé™¤äº†optionsã€‚åœ¨ options ä¸­æŒ‡å®šçš„ä¿¡æ¯ä¼šä½œä¸ºä»»åŠ¡çš„é…ç½®é€‰é¡¹å‡ºç°
å­ç›®æ ‡ä»»åŠ¡çš„é…ç½®é€‰é¡¹ä¼šè¦†ç›–ç›®æ ‡ä»»åŠ¡çš„é…ç½®é€‰é¡¹

```js
// gruntfile.js
module.exports = grunt => {
  // å¤šç›®æ ‡æ¨¡å¼ï¼Œå¯ä»¥è®©ä»»åŠ¡æ ¹æ®é…ç½®å½¢æˆå¤šä¸ªå­ä»»åŠ¡

  // grunt.initConfig({
  //   build: {
  //     foo: 100,
  //     bar: '456'
  //   }
  // })

  // grunt.registerMultiTask('build', function () {
  //   console.log(`task: build, target: ${this.target}, data: ${this.data}`)
  // })

  grunt.initConfig({
    build: {
      options: {
        msg: 'task options'
      },
      foo: {
        options: {
          msg: 'foo target options'
        }
      },
      bar: '456'
    }
  })

  grunt.registerMultiTask('build', function () {
    console.log(this.options()) // å¯ä»¥è·å–åˆ°ç›¸åº”çš„é…ç½®é€‰é¡¹
  })
}
```

### æ’ä»¶

æ’ä»¶æœºåˆ¶æ˜¯ Grunt çš„æ ¸å¿ƒã€‚æ’ä»¶å†…éƒ¨å°è£…äº†å¾ˆå¤šé€šç”¨çš„æ„å»ºä»»åŠ¡ï¼Œä¸€èˆ¬æˆ‘ä»¬çš„æ„å»ºè¿‡ç¨‹éƒ½æ˜¯ç”±è¿™äº›é€šç”¨çš„æ„å»ºä»»åŠ¡ç»„æˆçš„ã€‚

**æ’ä»¶çš„ä½¿ç”¨æ­¥éª¤ï¼š**

1. é€šè¿‡ npm å®‰è£…ç›¸åº”æ’ä»¶
2. åœ¨ gruntfile ä¸­è½½å…¥æ’ä»¶æä¾›çš„ä»»åŠ¡
3. é€šè¿‡æ’ä»¶çš„æ–‡æ¡£é…ç½®å¥½éœ€è¦çš„é…ç½®é€‰é¡¹

**ğŸŒ° æ —å­**

```bash
# 1. å®‰è£…æ’ä»¶
yarn add grunt-contrib-clean
```

```js
// 2. è½½å…¥æ’ä»¶
module.exports = grunt => {
  // 3. é…ç½®é€‰é¡¹
  grunt.initConfig({
    clean: {
      temp: 'temp/**' // å¯ä»¥æŒ‡å®šæ–‡ä»¶ temp/read.txtã€æˆ–è€…é€šé…æŸç±»å‹æ–‡ä»¶ temp/*.txt
    }
  })
  
  grunt.loadNpmTasks('grunt-contrib-clean')
}
```

#### å¸¸ç”¨æ’ä»¶

##### grunt-sass

**å®‰è£…**

```bash
yarn add grunt-sass sass --dev
```

```js
const sass = require('sass')
const loadGruntTasks = require('load-grunt-tasks')

module.exports = grunt => {
  grunt.initConfig({
    sass: {
      options: {
        sourceMap: true,
        implementation: sass
      },
      main: {
        files: {
          // è¾“å‡ºçš„è·¯å¾„: åŸè·¯å¾„
          'dist/css/main.css': 'src/scss/main.scss'
        }
      }
    }
  })

  grunt.loadNpmTasks('grunt-sass')
}
```

##### grunt-babel

**å®‰è£…** `yarn add grunt-babel @babel/core @babel/preset-env --dev`

```bash
yarn add load-grunt-tasks --dev
```

```js
const sass = require('sass')
const loadGruntTasks = require('load-grunt-tasks')

module.exports = grunt => {
  grunt.initConfig({
    ...
    babel: {
      options: {
        sourceMap: true,
        presets: ['@babel/preset-env']
      },
      main: {
        files: {
          'dist/js/app.js': 'src/js/app.js'
        }
      }
    }
  })
  loadGruntTasks(grunt) // è‡ªåŠ¨åŠ è½½æ‰€æœ‰çš„ grunt æ’ä»¶ä¸­çš„ä»»åŠ¡
}
```

##### grunt-contrib-watch

```bash
yarn add grunt-contrib-watch --dev
```

```js
const sass = require('sass')
const loadGruntTasks = require('load-grunt-tasks')

module.exports = grunt => {
  grunt.initConfig({
    ...
    watch: {
      js: {
        files: ['src/js/*.js'],
        tasks: ['babel']
      },
      css: {
        files: ['src/scss/*.scss'],
        tasks: ['sass']
      }
    }
  })

  loadGruntTasks(grunt) // è‡ªåŠ¨åŠ è½½æ‰€æœ‰çš„ grunt æ’ä»¶ä¸­çš„ä»»åŠ¡

  grunt.registerTask('default', ['sass', 'babel', 'watch'])
}
```



## Gulp

### åŸºæœ¬ä½¿ç”¨

```bash
# åˆå§‹åŒ– package.json
yarn init --y
# å®‰è£…ç›¸åº”ä¾èµ–
yarn add gulp --dev
# åˆ›å»ºgulpå…¥å£æ–‡ä»¶
code gulpfile.js
# ä¹¦å†™ gulpfile.js
# è¿è¡Œç›¸åº”å‘½ä»¤ yarn gulp <task name>
yarn gulp foo
```

```js
// å¯¼å‡ºçš„å‡½æ•°éƒ½ä¼šä½œä¸º gulp ä»»åŠ¡
// gulp çš„ä»»åŠ¡å‡½æ•°éƒ½æ˜¯å¼‚æ­¥çš„
// å¯ä»¥é€šè¿‡è°ƒç”¨å›è°ƒå‡½æ•°æ ‡è¯†ä»»åŠ¡å®Œæˆ
exports.foo = done => {
  console.log('foo task working~')
  done() // æ ‡è¯†ä»»åŠ¡æ‰§è¡Œå®Œæˆ
}

// default æ˜¯é»˜è®¤ä»»åŠ¡
// åœ¨è¿è¡Œæ˜¯å¯ä»¥çœç•¥ä»»åŠ¡åå‚æ•°
exports.default = done => {
  console.log('default task working~')
  done()
}

// -----
// v4.0 ä¹‹å‰éœ€è¦é€šè¿‡ gulp.task() æ–¹æ³•æ³¨å†Œä»»åŠ¡
const gulp = require('gulp')

gulp.task('bar', done => {
  console.log('bar task working~')
  done()
})
```

### åˆ›å»ºç»„åˆä»»åŠ¡

```js
const { series, parallel } = require('gulp')

const task1 = done => {
  setTimeout(() => {
    console.log('task1 working~')
    done()
  }, 1000)
}

const task2 = done => {
  setTimeout(() => {
    console.log('task2 working~')
    done()
  }, 1000)  
}

const task3 = done => {
  setTimeout(() => {
    console.log('task3 working~')
    done()
  }, 1000)  
}

// è®©å¤šä¸ªä»»åŠ¡æŒ‰ç…§é¡ºåºä¾æ¬¡æ‰§è¡Œ
exports.foo = series(task1, task2, task3)

// è®©å¤šä¸ªä»»åŠ¡åŒæ—¶æ‰§è¡Œ
exports.bar = parallel(task1, task2, task3)
```

### å¼‚æ­¥ä»»åŠ¡

```js
const fs = require('fs')

exports.callback = done => {
  console.log('callback task')
  done()
}

exports.callback_error = done => {
  console.log('callback task')
  done(new Error('task failed'))
}

exports.promise = () => {
  console.log('promise task')
  return Promise.resolve()
}

exports.promise_error = () => {
  console.log('promise task')
  return Promise.reject(new Error('task failed'))
}

const timeout = time => {
  return new Promise(resolve => {
    setTimeout(resolve, time)
  })
}

exports.async = async () => {
  await timeout(1000)
  console.log('async task')
}

exports.stream = () => {
  const read = fs.createReadStream('yarn.lock')
  const write = fs.createWriteStream('a.txt')
  read.pipe(write)
  return read
}

// exports.stream = done => {
//   const read = fs.createReadStream('yarn.lock')
//   const write = fs.createWriteStream('a.txt')
//   read.pipe(write)
//   read.on('end', () => {
//     done()
//   })
// }
```

### æ„å»ºè¿‡ç¨‹æ ¸å¿ƒå·¥ä½œåŸç†

```js
const fs = require('fs')
const { Transform } = require('stream')

exports.default = () => {
  // æ–‡ä»¶è¯»å–æµ
  const readStream = fs.createReadStream('normalize.css')

  // æ–‡ä»¶å†™å…¥æµ
  const writeStream = fs.createWriteStream('normalize.min.css')

  // æ–‡ä»¶è½¬æ¢æµ
  const transformStream = new Transform({
    // æ ¸å¿ƒè½¬æ¢è¿‡ç¨‹
    transform: (chunk, encoding, callback) => {
      const input = chunk.toString()
      const output = input.replace(/\s+/g, '').replace(/\/\*.+?\*\//g, '')
      callback(null, output)
    }
  })

  return readStream
    .pipe(transformStream) // è½¬æ¢
    .pipe(writeStream) // å†™å…¥
}
```

![image-20220121155003851](./images/gulpæ„å»ºè¿‡ç¨‹æ ¸å¿ƒå·¥ä½œåŸç†.png)

### æ–‡ä»¶æ“ä½œAPI + æ’ä»¶çš„ä½¿ç”¨

> gulp æä¾›äº†æ–‡ä»¶è¯»å–æµå’Œå†™å…¥æµçš„APIï¼Œè´Ÿè´£æ–‡ä»¶åŠ å·¥çš„è½¬æ¢æµä¸€èˆ¬é€šè¿‡ç‹¬ç«‹çš„æ’ä»¶æä¾›ã€‚
> å®é™…é€šè¿‡Gulpåˆ›å»ºä»»åŠ¡æ—¶çš„æµç¨‹å°±æ˜¯å…ˆé€šè¿‡ src æ–¹æ³•åˆ›å»ºä¸€ä¸ªè¯»å–æµï¼Œå†é€šè¿‡æ’ä»¶æä¾›çš„è½¬æ¢æµå®ç°æ–‡ä»¶åŠ å·¥ï¼Œæœ€åé€šè¿‡ Gulp æä¾›çš„ dest æ–¹æ³•åˆ›å»ºä¸€ä¸ªå†™å…¥æµä»è€Œå†™å…¥åˆ°ç›®æ ‡æ–‡ä»¶

```js
const { src, dest } = require('gulp')

export default = () => {
  return src('src/*.css').pipe(desc('dist'))
}
```

**å‹ç¼©CSSæ–‡ä»¶çš„æ’ä»¶ï¼š** `yarn add gulp-clean-css --dev`

```js
const { src, dest } = require('gulp')
const cleanCSS = require('gulp-clean-css')

export default = () => {
  return src('src/*.css').pipe(cleanCSS()).pipe(desc('dist'))
}
```



### Gulp è‡ªåŠ¨åŒ–æ„å»ºæ¡ˆä¾‹

#### 1. å…‹éš†é¡¹ç›®

https://github.com/CrystalAngelLee/zce-gulp-demo

#### 2. å®‰è£…é¡¹ç›®ä¾èµ–

```bash
yarn add gulp --dev
```

#### 3. æ–°å»º gulpfile.js

##### 3.1 æ ·å¼ç¼–è¯‘

**å®‰è£…ç›¸å…³æ’ä»¶ï¼š** `yarn add gulp-sass --dev`

```js
const { src, dest } = require('gulp')
const sass = require('gulp-sass')

const style = () => {
  /**
  * base: 'src'  å¸®åŠ©æˆ‘ä»¬ä¿ç•™åŸæœ‰çš„ç›®å½•ç»“æ„
  * sass æ’ä»¶ï¼šä»¥ _ å¼€å¤´çš„æ–‡ä»¶é»˜è®¤ä¸ºä¸»æ–‡ä»¶ä¾èµ–çš„æ–‡ä»¶ï¼Œè½¬æ¢æ—¶ä¼šè¢«å¿½ç•¥æ‰
  * outputStyle: 'expanded'  æ ·å¼ä»£ç è¾“å‡ºæ ¼å¼è°ƒæ•´
  */
  return src('src/assets/styles/*.scss', { base: 'src' })
    .pipe(sass({ outputStyle: 'expanded' }))
    .pipe(dest('dist'))
}

module.exports = {
  style
}
// è¿è¡Œå‘½ä»¤ yarn gulp style
```

##### 3.2 è„šæœ¬æ–‡ä»¶ç¼–è¯‘

> JS æ–‡ä»¶

**å®‰è£…ç›¸å…³æ’ä»¶ï¼š** `yarn add gulp-babel @babel/core @babel/preset-env --dev`

```js
const { src, dest } = require('gulp')
const babel = require('gulp-babel')

//...
const script = () => {
  /**
  * babel çš„ä»£ç å¯ä»¥æ”¾åˆ°å½“å‰æ–‡ä»¶ä¸­é…ç½®ï¼Œä¹Ÿå¯ä»¥æ”¾åˆ° .babelrc ä¸­è¿›è¡Œé…ç½®
  */
  return src('src/assets/scripts/*.js', { base: 'src' })
    .pipe(babel({ presets: ['@babel/preset-env'] }))
    .pipe(dest('dist'))
}

module.exports = {
  style,
  script
}
// è¿è¡Œå‘½ä»¤ yarn gulp script
```

##### 3.3 é¡µé¢æ–‡ä»¶ç¼–è¯‘

> HTML æ–‡ä»¶

**å®‰è£…ç›¸å…³æ’ä»¶ï¼š** `yarn add gulp-swig --dev`

```js
const { src, dest } = require('gulp')
const swig = require('gulp-swig')

//...
const page = () => {
  /**
   * src ä¸‹é¢çš„ä»»æ„å­ç›®å½•ä¸‹çš„ html æ–‡ä»¶åŒ¹é…ï¼š src/**/*.html
  */
  return src('src/*.html', { base: 'src' })
    .pipe(swig({ data, defaults: { cache: false } })) // é˜²æ­¢æ¨¡æ¿ç¼“å­˜å¯¼è‡´é¡µé¢ä¸èƒ½åŠæ—¶æ›´æ–°
    .pipe(dest('dist'))
}

module.exports = {
  ...
  page
}
// è¿è¡Œå‘½ä»¤ yarn gulp page
```

```js
const data = {
  menus: [
    {
      name: 'Home',
      icon: 'aperture',
      link: 'index.html'
    },
    {
      name: 'Features',
      link: 'features.html'
    },
    {
      name: 'About',
      link: 'about.html'
    },
    {
      name: 'Contact',
      link: '#',
      children: [
        {
          name: 'Twitter',
          link: 'https://twitter.com/w_zce'
        },
        {
          name: 'About',
          link: 'https://weibo.com/zceme'
        },
        {
          name: 'divider'
        },
        {
          name: 'About',
          link: 'https://github.com/zce'
        }
      ]
    }
  ],
  pkg: require('./package.json'),
  date: new Date()
}
```

##### 3.4 åˆ›å»ºç»„åˆä»»åŠ¡

å°†ä¸Šè¿°å‡ ä¸ªç¼–è¯‘å‘½ä»¤ç»„åˆä¸ºä¸€ä¸ªä»»åŠ¡æ‰§è¡Œ

```js
const { src, dest, parallel } = require('gulp')
// ...
const compile = parallel(style, script, page)

module.exports = {
  compile
}
// è¿è¡Œå‘½ä»¤ yarn gulp compile
```

##### 3.5 å›¾ç‰‡å’Œå­—ä½“æ–‡ä»¶çš„è½¬æ¢

**å®‰è£…ç›¸å…³æ’ä»¶ï¼š** `yarn add gulp-imagemin --dev`

```js
const imagemin = require('gulp-imagemin')

const image = () => {
  return src('src/assets/images/**', { base: 'src' })
    .pipe(imagemin())
    .pipe(dest('dist'))
}

const font = () => {
  return src('src/assets/fonts/**', { base: 'src' })
    .pipe(imagemin())
    .pipe(dest('dist'))
}

module.exports = {
  image,
  font
}
```

å¯ä»¥å°† image æŒ‡ä»¤å’Œ font æŒ‡ä»¤åˆå¹¶åˆ° compile ä¸­ï¼Œå³ `const compile = parallel(style, script, page, image, font)`

##### 3.6 å…¶ä»–æ–‡ä»¶åŠæ–‡ä»¶æ¸…é™¤

```js
const extra = () => {
  return src('public/**', { base: 'public' })
    .pipe(dest('dist'))
}

// å®Œæˆ src ä¸‹é¢éœ€è¦ç¼–è¯‘çš„æ–‡ä»¶çš„è½¬æ¢
const compile = parallel(style, script, page, image, font)
// æ‰€æœ‰æ–‡ä»¶çš„æ„å»º
const build =  parallel(compile, extra)

module.exports = {
  compile,
  build
}
```

**æ¸…é™¤ dist ç›®å½•ä¸‹çš„æ–‡ä»¶**

**å®‰è£…ç›¸å…³æ’ä»¶ï¼š** `yarn add del --dev`

```js
const { src, dest, parallel, series, watch } = require('gulp')

const del = require('del')

const clean = () => {
  return del(['dist'])
}

// ä¿®æ”¹ build ä»»åŠ¡
const build =  series(
  clean,
  parallel(compile, extra)
)
```

##### 3.7 è‡ªåŠ¨åŠ è½½æ’ä»¶

æ„å»ºä»»åŠ¡è¶Šæ¥è¶Šå¤šä¼šå¯¼è‡´ä½¿ç”¨çš„æ’ä»¶è¶Šæ¥è¶Šå¤šï¼Œå¯ä»¥é€šè¿‡ä¸€ä¸ªæ’ä»¶æ¥ç»Ÿä¸€ç®¡ç†æ‰€åº”ç”¨åˆ°çš„æ’ä»¶

**å®‰è£…ç›¸å…³æ’ä»¶ï¼š** `yarn add gulp-load-plugins --dev`

```js
const { src, dest, parallel, series, watch } = require('gulp')

// ...

const loadPlugins = require('gulp-load-plugins')

const plugins = loadPlugins()

const style = () => {
  return src('src/assets/styles/*.scss', { base: 'src' })
    .pipe(plugins.sass({ outputStyle: 'expanded' }))
    .pipe(dest('dist'))
    .pipe(bs.reload({ stream: true }))
}

const script = () => {
  return src('src/assets/scripts/*.js', { base: 'src' })
    .pipe(plugins.babel({ presets: ['@babel/preset-env'] }))
    .pipe(dest('dist'))
    .pipe(bs.reload({ stream: true }))
}

const page = () => {
  return src('src/*.html', { base: 'src' })
    .pipe(plugins.swig({ data, defaults: { cache: false } })) // é˜²æ­¢æ¨¡æ¿ç¼“å­˜å¯¼è‡´é¡µé¢ä¸èƒ½åŠæ—¶æ›´æ–°
    .pipe(dest('dist'))
    .pipe(bs.reload({ stream: true }))
}

const image = () => {
  return src('src/assets/images/**', { base: 'src' })
    .pipe(plugins.imagemin())
    .pipe(dest('dist'))
}

const font = () => {
  return src('src/assets/fonts/**', { base: 'src' })
    .pipe(plugins.imagemin())
    .pipe(dest('dist'))
}

const extra = () => {
  return src('public/**', { base: 'public' })
    .pipe(dest('dist'))
}


const compile = parallel(style, script, page, image, font)

// ä¸Šçº¿ä¹‹å‰æ‰§è¡Œçš„ä»»åŠ¡
const build =  series(
  clean,
  parallel(
    compile,
    extra
  )
)

module.exports = {
  build
}
```

##### 3.8 çƒ­æ›´æ–°å¼€å‘æœåŠ¡å™¨

**å®‰è£…ç›¸å…³æ’ä»¶ï¼š** `yarn add browser-sync --dev`

```js
const browserSync = require('browser-sync')
const bs = browserSync.create()

const serve = () => {
  bs.init({
    notify: false,
    port: 2080, // å¯åŠ¨ç«¯å£
    // open: false, // è‡ªåŠ¨å¯åŠ¨æµè§ˆå™¨
    files: 'dist/**', // æ–‡ä»¶å¤¹ä¸‹çš„æ–‡ä»¶å‘ç”Ÿæ”¹å˜åè‡ªåŠ¨åˆ·æ–°æµè§ˆå™¨
    server: {
      baseDir: 'dist',
      routes: {
        '/node_modules': 'node_modules' // ä¼˜å…ˆäº baseDir çš„é…ç½®
      }
    }
  })
}

module.exports = {
  build,
  serve
}
```

**src ç›®å½•ä¸‹ä»£ç æ›´æ–°åè‡ªåŠ¨æ„å»ºå¹¶åˆ·æ–°æµè§ˆå™¨**

```js
const { src, dest, parallel, series, watch } = require('gulp')

const serve = () => {
  watch('src/assets/styles/*.scss', style)
  watch('src/assets/scripts/*.js', script)
  watch('src/*.html', page)
  // watch('src/assets/images/**', image)
  // watch('src/assets/fonts/**', font)
  // watch('public/**', extra)
  // å‡å°‘æ„å»ºæ¬¡æ•°
  watch([
    'src/assets/images/**',
    'src/assets/fonts/**',
    'public/**'
  ], bs.reload)

  bs.init({
    notify: false,
    port: 2080, // å¯åŠ¨ç«¯å£
    // open: false, // è‡ªåŠ¨å¯åŠ¨æµè§ˆå™¨
    // å¯ä»¥é€šè¿‡ æ¯ä¸ªä»»åŠ¡ä¸‹æ·»åŠ  bs.reload æ›¿æ¢
    files: 'dist/**', // æ–‡ä»¶å¤¹ä¸‹çš„æ–‡ä»¶å‘ç”Ÿæ”¹å˜åè‡ªåŠ¨åˆ·æ–°æµè§ˆå™¨
    server: {
      // é€šè¿‡æ•°ç»„æŸ¥æ‰¾ï¼šç¬¬ä¸€ä¸ªç›®å½•ä¸‹æŸ¥æ‰¾ä¸åˆ°çš„è¯ä¸€æ¬¡å¾€åç»­ç›®å½•ä¸‹æŸ¥æ‰¾
      // å›¾ç‰‡å­—ä½“æ–‡ä»¶ & public ç›®å½•ä¸‹çš„æ–‡ä»¶åœ¨å¼€å‘é˜¶æ®µæ‰¾ src ä¸‹é¢çš„æ–‡ä»¶å’Œdistä¸‹é¢çš„æ–‡ä»¶æ˜¯ä¸€æ ·çš„
      baseDir: ['dist', 'src', 'public'],
      routes: {
        '/node_modules': 'node_modules' // ä¼˜å…ˆäº baseDir çš„é…ç½®
      }
    }
  })
}

// ä¿®æ”¹ç›¸å…³æŒ‡ä»¤ï¼š åœ¨å¼€å‘é˜¶æ®µä¸éœ€è¦å¯¹å­—ä½“å›¾ç‰‡æ–‡ä»¶è¿›è¡Œé¢‘ç¹æ‰“åŒ…å¤„ç†
const compile = parallel(style, script, page)

// ä¸Šçº¿ä¹‹å‰æ‰§è¡Œçš„ä»»åŠ¡
const build =  series(
  clean,
  parallel(
    compile,
    image,
    font,
    extra
  )
)

// å¼€å‘é˜¶æ®µæ‰§è¡Œ
const develop = series(compile, serve)

module.exports = {
  clean,
  build,
  compile,
  develop
}
```

æ¯ä¸ªä»»åŠ¡ä¸‹æ·»åŠ  bs.reload æ›¿æ¢ files æ–¹æ³•ï¼š

```js
const script = () => {
  return src('src/assets/scripts/*.js', { base: 'src' })
    .pipe(plugins.babel({ presets: ['@babel/preset-env'] }))
    .pipe(dest('dist'))
    .pipe(bs.reload({ stream: true }))
}
```

å°† styleã€scriptã€page ä»»åŠ¡æ·»åŠ ä¸Šå³å¯

##### 3.9 useref æ–‡ä»¶å¼•ç”¨å¤„ç†

**å®‰è£…ç›¸å…³æ’ä»¶ï¼š** `yarn add gulp-useref --dev`

```js
const useref = () => {
  return src('temp/*.html', { base: 'dist' })
    .pipe(plugins.useref({ searchPath: ['dist', '.'] }))
    .pipe(dest('dist'))
}
```

**åˆ†åˆ«å‹ç¼© HTMLã€CSSã€JS**

**å®‰è£…ç›¸å…³æ’ä»¶ï¼š** `yarn add gulp-htmlmin gulp-uglify gulp-clean-css gulp-if --dev`

```js
const useref = () => {
  return src('dist/*.html', { base: 'dist' })
    .pipe(plugins.useref({ searchPath: ['dist', '.'] }))
    // html js css
    .pipe(plugins.if(/\.js$/, plugins.uglify()))
    .pipe(plugins.if(/\.css$/, plugins.cleanCss()))
    .pipe(plugins.if(/\.html$/, plugins.htmlmin({
      collapseWhitespace: true,
      minifyCSS: true,
      minifyJS: true
    })))
    .pipe(dest('dist'))
}
```

1. è¿è¡Œå‘½ä»¤ yarn gulp compile
2. è¿è¡Œå‘½ä»¤ yarn gulp useref

**å½“å‰åº”ç”¨å­˜åœ¨é—®é¢˜**

è¯»å†™æµåŒæ—¶åœ¨dist æ–‡ä»¶å¤¹ä¸­è¿›è¡Œæ“ä½œï¼Œä¼šå­˜åœ¨æ–‡ä»¶å†™ä¸è¿›å»çš„æƒ…å†µ

**é—®é¢˜è§£å†³æ–¹æ¡ˆ**

å°†è¾“å‡ºæ–‡ä»¶çš„ç›®å½•æ›´æ”¹å³å¯

##### 3.10 é‡æ–°è§„åˆ’æ„å»ºè¿‡ç¨‹

> ç”±äºåœ¨ 3.9 æ­¥éª¤ç ´åäº†æ–‡ä»¶è¯»å†™çš„æ„å»ºç»“æ„ï¼Œè¿™é‡Œæˆ‘ä»¬éœ€è¦é‡æ–°è§„åˆ’ä¸€ä¸‹

åœ¨useref ä¹‹å‰çš„æ“ä½œéƒ½æ˜¯ä¸´æ—¶çš„å­˜å‚¨ï¼Œåœ¨useref æ“ä½œçš„æ—¶å€™æˆ‘ä»¬å°†æ–‡ä»¶ä»ä¸´æ—¶æ–‡ä»¶å¤¹ä¸­å–å‡ºæ¥ï¼Œç„¶åå°†ä»–ä»¬æ”¾åˆ° dist æ–‡ä»¶å¤¹ä¸­

**ä¿®æ”¹ clean ä»»åŠ¡**

```js
const clean = () => {
  return del(['dist', 'temp'])
}
```

**ä¿®æ”¹ styleã€scriptã€page ä»»åŠ¡**

```js
const style = () => {
  return src('src/assets/styles/*.scss', { base: 'src' })
    .pipe(plugins.sass({ outputStyle: 'expanded' }))
    .pipe(dest('temp'))
    .pipe(bs.reload({ stream: true }))
}

const script = () => {
  return src('src/assets/scripts/*.js', { base: 'src' })
    .pipe(plugins.babel({ presets: ['@babel/preset-env'] }))
    .pipe(dest('temp'))
    .pipe(bs.reload({ stream: true }))
}

const page = () => {
  return src('src/*.html', { base: 'src' })
    .pipe(plugins.swig({ data, defaults: { cache: false } })) // é˜²æ­¢æ¨¡æ¿ç¼“å­˜å¯¼è‡´é¡µé¢ä¸èƒ½åŠæ—¶æ›´æ–°
    .pipe(dest('temp'))
    .pipe(bs.reload({ stream: true }))
}
```

å› ä¸º imageã€fontã€extra åªä¼šåœ¨ä¸Šçº¿æ—¶æ“ä½œï¼Œæ‰€ä»¥ä¸éœ€è¦æ”¾åœ¨ä¸´æ—¶æ–‡ä»¶å¤¹ä¸­

**ä¿®æ”¹ serve ä»»åŠ¡**

```js
const serve = () => {
  // ...
  bs.init({
    // ...
    server: {
      baseDir: ['temp', 'src', 'public'],
      routes: {
        '/node_modules': 'node_modules'
      }
    }
  })
}
```

**ä¿®æ”¹ useref ä»»åŠ¡**

```js
const useref = () => {
  return src('temp/*.html', { base: 'temp' })
   	...
}
```

**ä¿®æ”¹ build ä»»åŠ¡**

```js
const build =  series(
  clean,
  parallel(
    series(compile, useref),
    image,
    font,
    extra
  )
)
```

**ä¿®æ”¹æš´éœ²æŒ‡ä»¤**

```js
module.exports = {
  clean,
  build,
  develop
}
```

**é…ç½® scripts å‘½ä»¤**

> package.json

```json
"scripts": {
    "clean": "gulp clean",
    "build": "gulp build",
    "develop": "gulp develop"
 },
```

**.gitignore å¿½ç•¥æ–‡ä»¶å¤¹**

```tex
...

dist
temp
```



### å°è£…è‡ªåŠ¨åŒ–æ„å»ºå·¥ä½œæµ

> **gulpfile.js çš„å¤ç”¨é—®é¢˜**
>
> å¦‚æœæ¶‰åŠåˆ°å¼€å‘å¤šä¸ªåŒç±»å‹çš„é¡¹ç›®ï¼Œè‡ªåŠ¨åŒ–æ„å»ºå·¥ä½œæµåº”è¯¥æ˜¯ä¸€æ ·çš„ã€‚è¿™å°±æ¶‰åŠåˆ°å¤šä¸ªé¡¹ç›®é‡å¤ä½¿ç”¨æ„å»ºä»»åŠ¡ï¼ˆç»å¤§å¤šæ•°éƒ½æ˜¯ç›¸åŒçš„ï¼‰ã€‚
>
> **æå–å¯å¤ç”¨çš„è‡ªåŠ¨åŒ–æ„å»ºå·¥ä½œæµ**
>
> åˆ›å»ºä¸€ä¸ªæ–°çš„æ¨¡å—ï¼Œå»åŒ…è£…ä¸€ä¸‹gulpï¼Œå°†è‡ªåŠ¨åŒ–å·¥ä½œæµåŒ…è£…è¿›å»

**åˆ›å»ºä¸€ä¸ªæ–°çš„æ¨¡å—ï¼Œå¹¶å°†å…¶å‘å¸ƒåˆ° npm ä¸Šã€‚ç„¶åæˆ‘ä»¬åœ¨é¡¹ç›®ä¸­ä½¿ç”¨è¿™ä¸ªæ¨¡å—å°±å¥½äº†**

1. åˆ›å»ºè¿œç¨‹ git ä»“åº“å¹¶åŒæ­¥æ–°çš„é¡¹ç›®åˆ°è¿œç«¯

2. å°† `Gulp è‡ªåŠ¨åŒ–æ„å»ºæ¡ˆä¾‹` ä¸­çš„ `gulpfile.js` æ–‡ä»¶å¤åˆ¶åˆ°æ–°é¡¹ç›®çš„å…¥å£æ–‡ä»¶ä¸­ï¼Œå¹¶å°†ç›¸å…³å¼€å‘ä¾èµ–å¤åˆ¶åˆ°æ–°é¡¹ç›® package.json çš„`dependencies` ä¸­
   åœ¨æ–°é¡¹ç›®ä¸­æ‰§è¡Œ yarn å®‰è£…æ‹·è´è¿‡æ¥çš„ä¾èµ–

3. å°†åŸé¡¹ç›®ä¸­çš„ `gulpfile.js` çš„å†…å®¹å’Œ `package.json ` ä¸­ç›¸å…³çš„å¼€å‘ä¾èµ–åˆ é™¤ï¼ˆåˆ é™¤ node_modulesï¼‰

4. å°†æ–°çš„æ¨¡å—ï¼ˆé¡¹ç›®ï¼‰link åˆ°åŸé¡¹ç›®ä¸­

   - æ–°é¡¹ç›®ä¸‹ä½¿ç”¨å‘½ä»¤ `yarn link` å°†å½“å‰æ¨¡å— link åˆ°å…¨å±€
   - åœ¨åŸé¡¹ç›®ä¸‹ä½¿ç”¨å‘½ä»¤ `yarn link æ–°é¡¹ç›®åç§°`

5. ä¿®æ”¹åŸé¡¹ç›®  `gulpfile.js`

   ```js
   module.exports = require('æ–°é¡¹ç›®åç§°')
   ```

6. åœ¨åŸé¡¹ç›®ä¸­æ‰§è¡Œ `yarn` å®‰è£…ç›¸å…³ä¾èµ–

2. æµ‹è¯•å‘½ä»¤ `yarn build` <span style="color:red">ä¼šæŠ¥é”™</span>

~~ä»¥ä¸‹æ“ä½œä¸ºåœ¨å¼€å‘é˜¶æ®µæ‰€åšçš„äº‹æƒ…ï¼š~~

åœ¨åŸé¡¹ç›®ä¸­å®‰è£…gulp `yarn add gulp-cli gulp --dev` ä¹‹åå†æ¬¡æµ‹è¯•å‘½ä»¤

**æŠ½ç¦»å†™æ­»çš„è„šæœ¬å†…å®¹ data**

1. ä½¿ç”¨çº¦å®šçš„æ–¹å¼åœ¨åŸé¡¹ç›®ä¸‹åˆ›å»ºä¸€ä¸ªé…ç½®æ–‡ä»¶(æ¯”å¦‚åœ¨æ ¹ç›®å½•ä¸‹çš„ä¸€ä¸ªpages.config.js)

2. å°†dataåœ¨å½“å‰æ–‡ä»¶ä¸‹å¯¼å‡º

3. ä¿®æ”¹æ–°é¡¹ç›®ä¸‹çš„æ–‡ä»¶

   ```js
   const cwd = process.cwd() // è¿”å›å½“å‰å·¥ä½œç›®å½•
   let conf = {
     // default config
   }
   
   try {
     const loadConf = require(`${cwd}/pages.config.js`)
     conf = Object.assign({}, conf, loadConf)
   } catch (e) {}
   
   // ...
   const page = () => {
     return src('src/*.html', { base: 'src' })
       .pipe(plugins.swig({ data: conf.data, defaults: { cache: false } })) // é˜²æ­¢æ¨¡æ¿ç¼“å­˜å¯¼è‡´é¡µé¢ä¸èƒ½åŠæ—¶æ›´æ–°
       .pipe(dest('temp'))
       .pipe(bs.reload({ stream: true }))
   }
   ```

**ä¿®æ”¹ preset-env è½½å…¥æ–¹å¼**

```js
const script = () => {
  return src('src/assets/scripts/*.js', { base: 'src' })
    .pipe(plugins.babel({ presets: [require('@babel/preset-env')] }))
    .pipe(dest('temp'))
    .pipe(bs.reload({ stream: true }))
}
```

require æŸ¥æ‰¾æ–‡ä»¶ï¼šå…ˆæ‰¾å½“å‰æ–‡ä»¶å¤¹ä¸‹æ—¶å€™æœ‰æ‰€éœ€è¦çš„æ¨¡å—ï¼Œæ‰¾ä¸åˆ°ä¾æ¬¡å‘ä¸ŠæŸ¥æ‰¾

~~åœ¨åŸé¡¹ç›®ä¸‹æµ‹è¯•å‘½ä»¤ `yarn build`~~ 

**æŠ½è±¡è·¯å¾„é…ç½®**

```js
let conf = {
  // default config
  build: {
    src: "src",
    dist: "dist",
    temp: "temp",
    public: "public",
    paths: {
      styles: "assets/styles/*.scss",
      scripts: "assets/scripts/*.js",
      pages: "*.html",
      images: "assets/images/**",
      fonts: "assets/fonts/**",
    },
  },
}
```

ä¿®æ”¹å†™æ­»çš„åœ°æ–¹

```js
const clean = () => {
  return del([config.build.dist, config.build.temp]);
};

const style = () => {
  return src(config.build.paths.styles, {
    base: config.build.src,
    cwd: config.build.src,
  })
    .pipe(plugins.sass({ outputStyle: "expanded" }))
    .pipe(dest(config.build.temp))
    .pipe(bs.reload({ stream: true }));
};

const script = () => {
  return src(config.build.paths.scripts, {
    base: config.build.src,
    cwd: config.build.src,
  })
    .pipe(plugins.babel({ presets: [require("@babel/preset-env")] }))
    .pipe(dest(config.build.temp))
    .pipe(bs.reload({ stream: true }));
};

const page = () => {
  return src(config.build.paths.pages, {
    base: config.build.src,
    cwd: config.build.src,
  })
    .pipe(plugins.swig({ data: config.data, defaults: { cache: false } }))
    .pipe(dest(config.build.temp))
    .pipe(bs.reload({ stream: true }));
};

const image = () => {
  return src(config.build.paths.images, {
    base: config.build.src,
    cwd: config.build.src,
  })
    .pipe(plugins.imagemin())
    .pipe(dest(config.build.dist));
};

const font = () => {
  return src(config.build.paths.fonts, {
    base: config.build.src,
    cwd: config.build.src,
  })
    .pipe(plugins.imagemin())
    .pipe(dest(config.build.dist));
};

const extra = () => {
  return src("**", {
    base: config.build.public,
    cwd: config.build.public,
  }).pipe(dest(config.build.dist));
};

const serve = () => {
  watch(config.build.paths.styles, { cwd: config.build.src }, style);
  watch(config.build.paths.scripts, { cwd: config.build.src }, script);
  watch(config.build.paths.pages, { cwd: config.build.src }, page);
  // watch('src/assets/images/**', image)
  // watch('src/assets/fonts/**', font)
  // watch('public/**', extra)
  watch(
    [config.build.paths.images, config.build.paths.fonts],
    { cwd: config.build.src },
    bs.reload
  );

  watch("**", { cwd: config.build.public }, bs.reload);

  bs.init({
    notify: false,
    port: 2080,
    // open: false,
    // files: 'dist/**',
    server: {
      baseDir: [config.build.temp, config.build.dist, config.build.public],
      routes: {
        "/node_modules": "node_modules",
      },
    },
  });
};

const useref = () => {
  return (
    src(config.build.paths.pages, {
      base: config.build.temp,
      cwd: config.build.temp,
    })
      .pipe(plugins.useref({ searchPath: [config.build.temp, "."] }))
      // html js css
      .pipe(plugins.if(/\.js$/, plugins.uglify()))
      .pipe(plugins.if(/\.css$/, plugins.cleanCss()))
      .pipe(
        plugins.if(
          /\.html$/,
          plugins.htmlmin({
            collapseWhitespace: true,
            minifyCSS: true,
            minifyJS: true,
          })
        )
      )
      .pipe(dest(config.build.dist))
  );
};
```

æµ‹è¯•å‘½ä»¤

**åŒ…è£…Gulp cli**

1. åœ¨æ–°é¡¹ç›®ä¸‹æ–°å»º `bin/æ–°é¡¹ç›®åç§°.js`
   è¯¥æ–‡ä»¶ä½œä¸ºcliçš„æ‰§è¡Œå…¥å£

   ```js
   #!/usr/bin/env node
   
   process.argv.push('--cwd')
   process.argv.push(process.cwd())
   process.argv.push('--gulpfile')
   process.argv.push(require.resolve('..'))
   
   require('gulp/bin/gulp')
   ```

2. åœ¨æ–°é¡¹ç›®ä¸‹ package.json ä¸­æ·»åŠ  bin å­—æ®µ

   ```json
   "bin": "bin/æ–°é¡¹ç›®åç§°.js",
   ```

3. åœ¨åŸé¡¹ç›®ä¸­åˆ é™¤  `gulpfile.js` 

4. åœ¨åŸé¡¹ç›®ä¸­è¿è¡Œå‘½ä»¤ `æ¨¡å—å‘½ä»¤ build`

**å‘å¸ƒå¹¶ä½¿ç”¨æ¨¡å—**

1. ä¿®æ”¹ package.json

   ```json
   {
     "files": [
       "lib",
       "bin"
     ],
     "main": "lib/index.js",
     "bin": "bin/zce-pages.js",
     "directories": {
       "lib": "lib"
     },
   }
   ```

2. å‘å¸ƒæ¨¡å—

   ```bash
   # æäº¤ä¿®æ”¹
   git push
   # å‘å¸ƒæ¨¡å—
   yarn publish
   ```

   

## FIS

ç›¸æ¯”äº Grunt å’Œ Gulp, FIS çš„æ ¸å¿ƒç‰¹ç‚¹æ˜¯é«˜åº¦é›†æˆ

**å®‰è£…ï¼ˆä¹Ÿå¯ä»¥å®‰è£…åˆ°é¡¹ç›®ä¸­ï¼‰ï¼š** `yarn global add fis3`

**é…ç½®æ–‡ä»¶ï¼š fis-conf.js**

```js
fis.match('*.{js,scss,png}', {
  release: '/assets/$0'
})

fis.match('**/*.scss', {
  rExt: '.css',
  parser: fis.plugin('node-sass'),
  optimizer: fis.plugin('clean-css')
})

fis.match('**/*.js', {
  parser: fis.plugin('babel-6.x'),
  optimizer: fis.plugin('uglify-js')
})
```

