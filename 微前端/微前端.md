# å¾®å‰ç«¯

## what - ä»€ä¹ˆæ˜¯å¾®å‰ç«¯

å¾®å‰ç«¯æ˜¯ä¸€ç§è½¯ä»¶æ¶æ„ï¼Œå¯ä»¥å°†å‰ç«¯åº”ç”¨æ‹†è§£æˆä¸€äº›æ›´å°çš„èƒ½å¤Ÿç‹¬ç«‹å¼€å‘éƒ¨ç½²çš„å¾®å‹åº”ç”¨ï¼Œç„¶åå†å°†è¿™äº›å¾®åº”ç”¨è¿›è¡Œç»„åˆä½¿å…¶æˆä¸ºæ•´ä½“åº”ç”¨çš„æ¶æ„æ¨¡å¼ã€‚

```text
æ€ä¹ˆç†è§£å‘¢ï¼Ÿ
å°±æ˜¯è¯´å½“å‰æˆ‘ä»¬åœ¨ä½¿ç”¨æ¡†æ¶è¿›è¡Œå•é¡µåº”ç”¨å¼€å‘æ—¶ï¼Œæˆ‘ä»¬é‡‡ç”¨çš„æ˜¯ç»„ä»¶çš„æ–¹å¼è¿›è¡Œæ„å»ºç”¨æˆ·ç•Œé¢çš„ï¼Œåœ¨å¾®å‰ç«¯é‡Œé¢æˆ‘ä»¬éœ€è¦å°†è¿™äº›ç»„ä»¶å‡çº§ä¸ºä¸€ä¸ªä¸ªç‹¬ç«‹çš„åº”ç”¨ã€‚
æ¯”å¦‚ä¸‹é¢çš„é¡µé¢ä¸­æœ‰äº”ä¸ªéƒ¨åˆ†ï¼Œä½¿ç”¨ç»„ä»¶çš„æ–¹å¼è¿›è¡Œæ„å»ºçš„è¯å°±ä¼šæœ‰äº”ä¸ªä¸åŒçš„ç»„ä»¶ã€‚åœ¨å¾®å‰ç«¯æ¶æ„ä¸­ï¼Œæˆ‘ä»¬éœ€è¦å°†è¿™äº”ä¸ªç»„ä»¶å‡çº§æˆä¸ºäº”ä¸ªç‹¬ç«‹çš„åº”ç”¨
```

![å¾®å‰ç«¯](./images/å¾®å‰ç«¯.jpeg)

å¾®å‰ç«¯æ¶æ„ç±»ä¼¼äºç»„ä»¶æ¶æ„ï¼Œä½†ä¸åŒçš„æ˜¯ï¼Œç»„ä»¶ä¸èƒ½ç‹¬ç«‹æ„å»ºå’Œå‘å¸ƒï¼Œä½†æ˜¯å¾®å‰ç«¯ä¸­çš„åº”ç”¨æ˜¯å¯ä»¥çš„ã€‚

å¾®å‰ç«¯æ¶æ„ä¸æ¡†æ¶æ— å…³ï¼Œæ¯ä¸ªå¾®åº”ç”¨éƒ½å¯ä»¥ä½¿ç”¨ä¸åŒçš„æ¡†æ¶ã€‚



## why - å¾®å‰ç«¯çš„ä»·å€¼

**1. å¢é‡è¿ç§»**

è¿ç§»æ˜¯ä¸€é¡¹éå¸¸è€—æ—¶ä¸”è‰°éš¾çš„ä»»åŠ¡ï¼Œæ¯”å¦‚æœ‰ä¸€ä¸ªç®¡ç†ç³»ç»Ÿä½¿ç”¨ AngularJS å¼€å‘ç»´æŠ¤å·²ç»æœ‰å‡ å¹´æ—¶é—´ï¼Œä½†æ˜¯éšæ—¶é—´çš„æ¨ç§»å’Œå›¢é˜Ÿæˆå‘˜çš„å˜æ›´ï¼Œæ— è®ºä»å¼€å‘æˆæœ¬è¿˜æ˜¯ç”¨äººéœ€æ±‚ä¸Šï¼ŒAngularJS å·²ç»ä¸èƒ½æ»¡è¶³è¦æ±‚ï¼Œäºæ˜¯å›¢é˜Ÿæƒ³è¦æ›´æ–°æŠ€æœ¯æ ˆï¼Œæƒ³åœ¨å…¶ä»–æ¡†æ¶ä¸­å®ç°æ–°çš„éœ€æ±‚ï¼Œä½†æ˜¯ç°æœ‰é¡¹ç›®æ€ä¹ˆåŠï¼Ÿç›´æ¥è¿ç§»æ˜¯ä¸å¯èƒ½çš„ï¼Œåœ¨æ–°çš„æ¡†æ¶ä¸­å®Œå…¨é‡å†™ä¹Ÿä¸å¤ªç°å®ã€‚

ä½¿ç”¨å¾®å‰ç«¯æ¶æ„å°±å¯ä»¥è§£å†³é—®é¢˜ï¼Œåœ¨ä¿ç•™åŸæœ‰é¡¹ç›®çš„åŒæ—¶ï¼Œå¯ä»¥å®Œå…¨ä½¿ç”¨æ–°çš„æ¡†æ¶å¼€å‘æ–°çš„éœ€æ±‚ï¼Œç„¶åå†ä½¿ç”¨å¾®å‰ç«¯æ¶æ„å°†æ—§çš„é¡¹ç›®å’Œæ–°çš„é¡¹ç›®è¿›è¡Œæ•´åˆã€‚è¿™æ ·æ—¢å¯ä»¥ä½¿äº§å“å¾—åˆ°æ›´å¥½çš„ç”¨æˆ·ä½“éªŒï¼Œä¹Ÿå¯ä»¥ä½¿å›¢é˜Ÿæˆå‘˜åœ¨æŠ€æœ¯ä¸Šå¾—åˆ°è¿›æ­¥ï¼Œäº§å“å¼€å‘æˆæœ¬ä¹Ÿé™åˆ°çš„æœ€ä½ã€‚

**2. ç‹¬ç«‹å‘å¸ƒ**

åœ¨ç›®å‰çš„å•é¡µåº”ç”¨æ¶æ„ä¸­ï¼Œä½¿ç”¨ç»„ä»¶æ„å»ºç”¨æˆ·ç•Œé¢ï¼Œåº”ç”¨ä¸­çš„æ¯ä¸ªç»„ä»¶æˆ–åŠŸèƒ½å¼€å‘å®Œæˆæˆ–è€…bugä¿®å¤å®Œæˆåï¼Œæ¯æ¬¡éƒ½éœ€è¦å¯¹æ•´ä¸ªäº§å“é‡æ–°è¿›è¡Œæ„å»ºå’Œå‘å¸ƒï¼Œä»»åŠ¡è€—æ—¶æ“ä½œä¸Šä¹Ÿæ¯”è¾ƒç¹çã€‚

åœ¨ä½¿ç”¨äº†å¾®å‰ç«¯æ¶æ„åï¼Œå¯ä»¥å°†ä¸èƒ½çš„åŠŸèƒ½æ¨¡å—æ‹†åˆ†æˆç‹¬ç«‹çš„åº”ç”¨ï¼Œæ­¤æ—¶åŠŸèƒ½æ¨¡å—å°±å¯ä»¥å•ç‹¬æ„å»ºå•ç‹¬å‘å¸ƒäº†ï¼Œæ„å»ºæ—¶é—´ä¹Ÿä¼šå˜å¾—éå¸¸å¿«ï¼Œåº”ç”¨å‘å¸ƒåä¸éœ€è¦æ›´æ”¹å…¶ä»–å†…å®¹åº”ç”¨å°±ä¼šè‡ªåŠ¨æ›´æ–°ï¼Œè¿™æ„å‘³ç€ä½ å¯ä»¥è¿›è¡Œé¢‘ç¹çš„æ„å»ºå‘å¸ƒæ“ä½œäº†ã€‚

**3. å…è®¸å•ä¸ªå›¢é˜Ÿåšå‡ºæŠ€æœ¯å†³ç­–**

å› ä¸ºå¾®å‰ç«¯æ„æ¶ä¸æ¡†æ¶æ— å…³ï¼Œå½“ä¸€ä¸ªåº”ç”¨ç”±å¤šä¸ªå›¢é˜Ÿè¿›è¡Œå¼€å‘æ—¶ï¼Œæ¯ä¸ªå›¢é˜Ÿéƒ½å¯ä»¥ä½¿ç”¨è‡ªå·±æ“…é•¿çš„æŠ€æœ¯æ ˆè¿›è¡Œå¼€å‘ï¼Œä¹Ÿå°±æ˜¯å®ƒå…è®¸é€‚å½“çš„è®©å›¢é˜Ÿå†³ç­–ä½¿ç”¨å“ªç§æŠ€æœ¯ï¼Œä»è€Œä½¿å›¢é˜Ÿåä½œå˜å¾—ä¸å†åƒµç¡¬ã€‚



ğŸ“¢ **å¾®å‰ç«¯çš„ä½¿ç”¨åœºæ™¯ï¼š**

1. æ‹†åˆ†å·¨å‹åº”ç”¨ï¼Œä½¿åº”ç”¨å˜å¾—æ›´åŠ å¯ç»´æŠ¤

2. å…¼å®¹å†å²åº”ç”¨ï¼Œå®ç°å¢é‡å¼€å‘



## how - å¦‚ä½•å®ç°å¾®å‰ç«¯

> å’Œå¾®å‰ç«¯æ¶æ„ç›¸å…³çš„å››ä¸ªé—®é¢˜

**1. å¤šä¸ªå¾®åº”ç”¨å¦‚ä½•è¿›è¡Œç»„åˆ ?**

åœ¨å¾®å‰ç«¯æ¶æ„ä¸­ï¼Œé™¤äº†å­˜åœ¨å¤šä¸ªå¾®åº”ç”¨ä»¥å¤–ï¼Œè¿˜å­˜åœ¨ä¸€ä¸ª**å®¹å™¨åº”ç”¨**ï¼Œæ¯ä¸ªå¾®åº”ç”¨éƒ½éœ€è¦è¢«æ³¨å†Œåˆ°å®¹å™¨åº”ç”¨ä¸­ã€‚

å¾®å‰ç«¯ä¸­çš„æ¯ä¸ªåº”ç”¨åœ¨æµè§ˆå™¨ä¸­éƒ½æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„ JavaScript æ¨¡å—ï¼Œé€šè¿‡æ¨¡å—åŒ–çš„æ–¹å¼è¢«å®¹å™¨åº”ç”¨å¯åŠ¨å’Œè¿è¡Œã€‚

ä½¿ç”¨æ¨¡å—åŒ–çš„æ–¹å¼è¿è¡Œåº”ç”¨å¯ä»¥é˜²æ­¢ä¸åŒçš„å¾®åº”ç”¨åœ¨åŒæ—¶è¿è¡Œæ—¶å‘ç”Ÿå†²çªã€‚

**2. åœ¨å¾®åº”ç”¨ä¸­å¦‚ä½•å®ç°è·¯ç”± ï¼Ÿ**

åœ¨å¾®å‰ç«¯æ¶æ„ä¸­ï¼Œå½“è·¯ç”±å‘ç”Ÿå˜åŒ–æ—¶ï¼Œå®¹å™¨åº”ç”¨é¦–å…ˆä¼šæ‹¦æˆªè·¯ç”±çš„å˜åŒ–ï¼Œæ ¹æ®è·¯ç”±åŒ¹é…å¾®å‰ç«¯åº”ç”¨ï¼Œå½“åŒ¹é…åˆ°å¾®åº”ç”¨ä»¥åï¼Œå†å¯åŠ¨å¾®åº”ç”¨è·¯ç”±ï¼ŒåŒ¹é…å…·ä½“çš„é¡µé¢ç»„ä»¶ã€‚

**3. å¾®åº”ç”¨ä¸å¾®åº”ç”¨ä¹‹é—´å¦‚ä½•å®ç°çŠ¶æ€å…±äº« ?**

åœ¨å¾®åº”ç”¨ä¸­å¯ä»¥é€šè¿‡**å‘å¸ƒè®¢é˜…æ¨¡å¼**å®ç°çŠ¶æ€å…±äº«ï¼Œæ¯”å¦‚ä½¿ç”¨ RxJSã€‚

**4. å¾®åº”ç”¨ä¸å¾®åº”ç”¨ä¹‹é—´å¦‚ä½•å®ç°æ¡†æ¶å’Œåº“çš„å…±äº«ï¼Ÿ**

é€šè¿‡ `import-map` å’Œ webpack ä¸­çš„ `externals` å±æ€§ã€‚

```
åœ¨å¾®åº”ç”¨æ¶æ„ä¸­æˆ‘ä»¬è¦ä½¿ç”¨æ¨¡å—åŒ–çš„æ–¹å¼å»åŠ è½½åº”ç”¨ã€‚
åœ¨æœ€æ–°çš„æ¨¡å—åŒ–å½“ä¸­æ–°å¢äº† import-map ç‰¹æ€§ï¼Œå…è®¸æˆ‘ä»¬åŠ è½½ç½‘ç»œæ¨¡å—ï¼Œè€Œä¸æ˜¯ä¸€å®šè¦å°†æ¨¡å—ä¸‹è½½åˆ°æœ¬åœ°ï¼Œæˆ‘ä»¬åªéœ€è¦é…ç½®å¥½æ¨¡å—åå­—å’Œå¯¹åº”çš„æ¨¡å—åœ°å€å³å¯ï¼Œè¿™æ ·æ¯ä¸ªå¾®åº”ç”¨åœ¨å¼•ç”¨å…¬å…±æ¨¡å—æ—¶éƒ½å¯ä»¥å¼•ç”¨æå‰é…ç½®å¥½çš„å…¬å…±æ¨¡å—äº†~
æˆ‘ä»¬è¿˜éœ€è¦ä¿®æ”¹å¾®åº”ç”¨æœ¬èº«çš„ webpack é…ç½®ï¼Œé€šè¿‡ webpack çš„ externals å±æ€§å‘Šè¯‰ webpack åœ¨æ‰“åŒ…åº”ç”¨æ—¶å“ªäº›æ¨¡å—æ˜¯ä¸éœ€è¦è¢«æ‰“åŒ…çš„
```



# [Systemjs](https://github.com/systemjs/systemjs) æ¨¡å—åŒ–è§£å†³æ–¹æ¡ˆ

> systemjs æ˜¯ä¸€ä¸ªåŠ¨æ€æ¨¡å—åŠ è½½å™¨

åœ¨å¾®å‰ç«¯æ¶æ„ä¸­ï¼Œå¾®åº”ç”¨ä¼šè¢«æ‰“åŒ…ä¸ºæ¨¡å—ï¼Œä½†æµè§ˆå™¨ä¸æ”¯æŒæ¨¡å—åŒ–ï¼Œéœ€è¦ä½¿ç”¨ systemjs å®ç°æµè§ˆå™¨ä¸­çš„æ¨¡å—åŒ–ã€‚

systemjs æ˜¯ä¸€ä¸ªç”¨äºå®ç°æ¨¡å—åŒ–çš„ JavaScript åº“ï¼Œæœ‰å±äºè‡ªå·±çš„æ¨¡å—åŒ–è§„èŒƒã€‚

åœ¨å¼€å‘é˜¶æ®µæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ ES æ¨¡å—è§„èŒƒï¼Œç„¶åä½¿ç”¨ webpack å°†å…¶è½¬æ¢ä¸º systemjs æ”¯æŒçš„æ¨¡å—ã€‚



â¤â¤â¤ 

ğŸ“¢ è¿™é‡Œè¯´æ˜ä¸€ä¸‹ï¼šå®Œæ•´demo çš„ä¹¦å†™æ˜¯å’Œæ–‡æ¡£ä¸­çš„åç§°ä¸ä¸€è‡´ï¼Œé€»è¾‘éƒ½æ˜¯ä¸€æ ·çš„å“ˆ

â¤â¤â¤



ğŸŒ° **æ —å­**

> é€šè¿‡ webpack å°† react åº”ç”¨æ‰“åŒ…ä¸º systemjs æ¨¡å—ï¼Œåœ¨é€šè¿‡ systemjs åœ¨æµè§ˆå™¨ä¸­åŠ è½½æ¨¡å—

ä¸€ã€å®‰è£…ä¾èµ–

```bash
npm install webpack@5.17.0 webpack-cli@4.4.0 webpack-dev-server@3.11.2 html-webpack-plugin@4.5.1 @babel/core@7.12.10 @babel/cli@7.12.10 @babel/preset-env@7.12.11 @babel/preset-react@7.12.10 babel-loader@8.2.2
```

äºŒã€åˆ›å»ºæ–‡ä»¶

```tex
1. åˆ›å»ºå…¥å£æ–‡ä»¶ src/index.js
2. åˆ›å»ºhtmlæ¨¡æ¿æ–‡ä»¶ src/index.html
```

```html
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>systemjs-react</title>
    /**
    	åŸç”Ÿ JS ä¸­ä¹Ÿå‡ºäº† importmap è¿™ä¸ªç‰¹æ€§ï¼Œä½†æ˜¯æµè§ˆå™¨å¯¹äºåŸç”Ÿçš„ç‰¹æ€§æ”¯æŒç¨‹åº¦ä¸å¤ªå¥½ï¼Œæ‰€ä»¥æˆ‘ä»¬ä½¿ç”¨ systemjs æä¾›çš„ importmap 
    **/
    <script type="systemjs-importmap">
    	// åœ¨å¾®å‰ç«¯æ¶æ„ä¸­ reactã€react-dom è¿™äº›å±äºå…¬å…±æ¡†æ¶ï¼Œæˆ‘ä»¬ä¸å¸Œæœ›åœ¨æ¯ä¸€ä¸ªå¾®åº”ç”¨ä¸­éƒ½å»ä¸‹è½½ã€æ‰“åŒ…
      {
        "imports": {
          "react": "https://cdn.jsdelivr.net/npm/react/umd/react.production.min.js",
          "react-dom": "https://cdn.jsdelivr.net/npm/react-dom/umd/react-dom.production.min.js",
          "react-router-dom": "https://cdn.jsdelivr.net/npm/react-router-dom@5.2.0/umd/react-router-dom.min.js"
        }
      }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/systemjs@6.8.0/dist/system.min.js"></script>
  </head>
  <body>
    <div id="root"></div>
    <script>
      System.import("./index.js")
    </script>
  </body>
</html>
```

```js
// index.js
import React from "react"
import ReactDOM from "react-dom"
import App from "./App.js"

/** ä»è¿™ä¸€æ­¥å¼€å§‹å°±æ˜¯react æ–¹é¢çš„å†…å®¹ */
ReactDOM.render(<App />, document.getElementById("root"))

// App.js
import React from "react"

export default function App() {
  return <div>Hello World</div>
}
```

ä¸‰ã€é…ç½® webpack

```js
// webpack.config.js
const path = require("path")
const HtmlWebpackPlugin = require("html-webpack-plugin")

module.exports = {
  mode: "development",
  entry: "./src/index.js",
  output: {
    filename: "index.js",
    path: path.join(__dirname, "build"),
    libraryTarget: "system" // !!! 1. å°† es-module è½¬æ¢æˆ system module
  },
  devtool: "source-map",
  devServer: {
    port: 9000, // åº”ç”¨è¿è¡Œçš„ç«¯å£
    contentBase: path.join(__dirname, "build"), // é™æ€èµ„æºæ–‡ä»¶å¤¹
    historyApiFallback: true
  },
  module: {
    rules: [
      {
        test: /\.js$/,
        exclude: /node_modules/,
        use: {
          loader: "babel-loader",
          options: {
            presets: ["@babel/preset-env", "@babel/preset-react"]
          }
        }
      }
    ]
  },
  plugins: [
    new HtmlWebpackPlugin({
      template: "./src/index.html", // åœ¨é»˜è®¤æƒ…å†µä¸‹ä¼šå¸®æˆ‘ä»¬å°† ./src/index.html æ–‡ä»¶æ‰“åŒ…åˆ° build ä¸­ï¼Œå¹¶ä¸”ä¼šæŠŠæˆ‘ä»¬æ‰“åŒ…çš„JS æ–‡ä»¶é€šè¿‡ script æ ‡ç­¾å¼•å…¥åˆ° html æ–‡ä»¶ä¸­ï¼Œä½†æ˜¯åœ¨å¾®å‰ç«¯æ¶æ„ä¸­å¼• JS æ–‡ä»¶çš„è¡Œä¸ºæ˜¯ä¸éœ€è¦çš„ï¼Œå› ä¸ºæˆ‘ä»¬éœ€è¦é€šè¿‡ systemjs å»åŠ è½½è¯¥æ¨¡å— 
      inject: false // !!! 3.é˜»æ­¢ JS æ–‡ä»¶çš„å¼•å…¥
    })
  ],
  externals: ["react", "react-dom", "react-router-dom"] // !!! 2. å“ªäº›æ¨¡å—æ˜¯ä¸éœ€è¦æ‰“åŒ…çš„
}
```

å››ã€æ·»åŠ å¯åŠ¨å‘½ä»¤

```json
"scripts": {
  "start": "webpack serve"
},
```

äº”ã€æµ‹è¯•

`npm start`

â˜ [å®Œæ•´ç‰ˆDemo Link](https://github.com/CrystalAngelLee/crystal-micro-frontend/tree/main/crystal-systemjs)



# å¾®å‰ç«¯æ¡†æ¶ [single-spa](https://single-spa.js.org/)

## single-spa æ¦‚è¿°

single-spa æ˜¯ä¸€ä¸ª**å®ç°å¾®å‰ç«¯æ¶æ„çš„æ¡†æ¶**ã€‚

åœ¨ single-spa æ¡†æ¶ä¸­æœ‰ä¸‰ç§ç±»å‹çš„å¾®å‰ç«¯åº”ç”¨ï¼š

1. single-spa-application / parcelï¼šå¾®å‰ç«¯æ¶æ„ä¸­çš„å¾®åº”ç”¨ï¼Œå¯ä»¥ä½¿ç”¨ vueã€reactã€angular ç­‰æ¡†æ¶ã€‚

   ```
   single-spa-application æ˜¯å’Œè·¯ç”±ç›¸å…³è”çš„ï¼Œæ¯”å¦‚è¯´å½“è®¿é—®/a è·¯ç”±çš„æ—¶å€™è¦è®¿é—®A å¾®åº”ç”¨ï¼Œè®¿é—® /b è·¯ç”±çš„æ—¶å€™è¦è®¿é—® B å¾®åº”ç”¨
   single-spa-parcel æ˜¯å’Œ single-spa-application ç›¸å…³è”çš„ä¸€ç§ç±»å‹ï¼Œä¸¤è€…ä½¿ç”¨æ–¹å¼éƒ½æ˜¯ä¸€æ ·çš„ï¼ŒåŒºåˆ«æ˜¯ single-spa-parcel ä¸è·Ÿè·¯ç”±ç›¸å…³è”ï¼Œä¸»è¦ç”¨äºè·¨åº”ç”¨å…±äº«UIç»„ä»¶
   ```

2. single-spa root configï¼šåˆ›å»ºå¾®å‰ç«¯å®¹å™¨åº”ç”¨ã€‚

   ```
   å¾®å‰ç«¯æ¶æ„ä¸­çš„å®¹å™¨åº”ç”¨ã€‚é€šè¿‡å®¹å™¨åº”ç”¨æ¥åŠ è½½å’Œç®¡ç†å¾®åº”ç”¨
   ```

3. utility modulesï¼šå…¬å…±æ¨¡å—åº”ç”¨ï¼Œéæ¸²æŸ“ç»„ä»¶ï¼Œç”¨äºè·¨åº”ç”¨å…±äº« javascript é€»è¾‘çš„å¾®åº”ç”¨ã€‚

ğŸ“¢ è¿™ä¸‰ç§å¾®åº”ç”¨éƒ½æ˜¯ç‹¬ç«‹çš„åº”ç”¨ï¼Œå‡å¯å•ç‹¬çš„å¼€å‘ã€æ„å»ºå’Œå‘å¸ƒ



â­ï¸ æ¥ä¸‹æ¥è®©æˆ‘ä»¬åˆ›å»ºå‡ ä¸ªåº”ç”¨æ¥ä½“éªŒä½¿ç”¨ä¸€ä¸‹å¼~~ â¤



## åˆ›å»ºå®¹å™¨åº”ç”¨

1. å®‰è£… single-spa è„šæ‰‹æ¶å·¥å…·ï¼š `npm install create-single-spa@2.0.3 -g `
   æŸ¥çœ‹ç‰ˆæœ¬ `npm info create-single-spa`

2. åˆ›å»ºå¾®å‰ç«¯åº”ç”¨ç›®å½•ï¼š`mkdir workspace && cd "$_" `

   ä¸åŒçš„å¾®åº”ç”¨å¯ä»¥æ”¾ç½®åœ¨ä¸åŒçš„æ–‡ä»¶å¤¹ä¸­

3. åˆ›å»ºå¾®å‰ç«¯å®¹å™¨åº”ç”¨ï¼š `create-single-spa` 
   1. åº”ç”¨æ–‡ä»¶å¤¹å¡«å†™ container

   2. åº”ç”¨é€‰æ‹© single-spa root config

   3. ç»„ç»‡åç§°å¡«å†™ study

      ç»„ç»‡åç§°å¯ä»¥ç†è§£ä¸ºå›¢é˜Ÿåç§°ï¼Œå¾®å‰ç«¯æ¶æ„å…è®¸å¤šå›¢é˜Ÿå…±åŒå¼€å‘åº”ç”¨ï¼Œç»„ç»‡åç§°å¯ä»¥æ ‡è¯†åº”ç”¨ç”±å“ªä¸ªå›¢é˜Ÿå¼€å‘ã€‚
      åº”ç”¨åç§°çš„å‘½åè§„åˆ™ä¸º @ç»„ç»‡åç§°/åº”ç”¨åç§° ï¼Œæ¯”å¦‚ @study/todos 

   ![image-20211101210529590](./images/å®¹å™¨åº”ç”¨.png)

4. å¯åŠ¨åº”ç”¨ï¼š `npm start `

5. è®¿é—®åº”ç”¨ï¼š` localhost:9000 `

   ğŸ“¢  1. åœ¨å®¹å™¨åº”ç”¨ä¸­é»˜è®¤æ³¨å†Œäº†ä¸€ä¸ªå¾®åº”ç”¨

   â€‹		2. åœ¨æ•´ä¸ªå¾®å‰ç«¯é¡¹ç›®ä¸­åªæœ‰ä¸€ä¸ªæ¨¡æ¿æ–‡ä»¶

6. é»˜è®¤ä»£ç è§£æ
   1. root-config.js

      ```js
      // workspace/container/src/study-root-config.js 
      import { registerApplication, start } from "single-spa"
      
      /**
       * æ³¨å†Œå¾®å‰ç«¯åº”ç”¨
       * 1. name: å­—ç¬¦ä¸²ç±»å‹, å¾®å‰ç«¯åº”ç”¨åç§° "@ç»„ç»‡åç§°/åº”ç”¨åç§°"
       * 2. app: å‡½æ•°ç±»å‹, è¿”å› Promise, é€šè¿‡ systemjs å¼•ç”¨æ‰“åŒ…å¥½çš„å¾®å‰ç«¯åº”ç”¨æ¨¡å—ä»£ç  (umd)
       * 3. activeWhen: è·¯ç”±åŒ¹é…æ—¶æ¿€æ´»åº”ç”¨
       */
      registerApplication({ 
        name: "@single-spa/welcome", 
        app: () => System.import( "https://unpkg.com/single-spa-welcome/dist/single-spa-welcome.js" ),
        activeWhen: ["/"] 
      })
      
      // start æ–¹æ³•å¿…é¡»åœ¨ single spa çš„é…ç½®æ–‡ä»¶ä¸­è°ƒç”¨
      // åœ¨è°ƒç”¨ start ä¹‹å‰, åº”ç”¨ä¼šè¢«åŠ è½½, ä½†ä¸ä¼šåˆå§‹åŒ–, æŒ‚è½½æˆ–å¸è½½.
      // å¯åŠ¨å¾®åº”ç”¨
      start({
        // æ˜¯å¦å¯ä»¥é€šè¿‡ history.pushState() å’Œ history.replaceState() æ›´æ”¹è§¦å‘ single-spa è·¯ç”± 
        // true ä¸å…è®¸ false å…è®¸
        urlRerouteOnly: true
      })
      ```

   2. index.ejs

      ```ejs
      <!-- å¯¼å…¥å¾®å‰ç«¯å®¹å™¨åº”ç”¨ -->
      <script>
        // åŠ è½½æ¨¡å—
        System.import("@study/root-config")
      </script>
      
      <!--
        import-map-overrides å¯ä»¥è¦†ç›–å¯¼å…¥æ˜ å°„ 
        å½“å‰é¡¹ç›®ä¸­ç”¨äºé…åˆ single-spa Inspector è°ƒè¯•å·¥å…·ä½¿ç”¨. 
        å¯ä»¥æ‰‹åŠ¨è¦†ç›–é¡¹ç›®ä¸­çš„ JavaScript æ¨¡å—åŠ è½½åœ°å€, ç”¨äºè°ƒè¯•. 
      -->
      <import-map-overrides-full
        show-when-local-storage="devtools"
        dev-libs
      ></import-map-overrides-full>
      ```

      ```ejs
      <!-- æ¨¡å—åŠ è½½å™¨ --> 
      <script src="https://cdn.jsdelivr.net/npm/systemjs@6.8.0/dist/system.min.js"></script> 
      <!-- systemjs ç”¨æ¥è§£æ AMD æ¨¡å—çš„æ’ä»¶ --> 
      <script src="https://cdn.jsdelivr.net/npm/systemjs@6.8.0/dist/extras/amd.min.js" ></script> 
      <!-- ç”¨äºè¦†ç›–é€šè¿‡ import-map è®¾ç½®çš„ JavaScript æ¨¡å—ä¸‹è½½åœ°å€ --> 
      <script src="https://cdn.jsdelivr.net/npm/import-map- overrides@2.2.0/dist/import-map-overrides.js"></script> 
      <!-- ç”¨äºæ”¯æŒ Angular åº”ç”¨ --> 
      <script src="https://cdn.jsdelivr.net/npm/zone.js@0.10.3/dist/zone.min.js"> </script>
      ```

      ```ejs
      <!-- single-spa é¢„åŠ è½½ --> 
      <link 
         rel="preload" 
         href="https://cdn.jsdelivr.net/npm/single-spa@5.8.3/lib/system/single- spa.min.js" 
         as="script" 
      />
      ```

      ```ejs
      <!-- JavaScript æ¨¡å—ä¸‹è½½åœ°å€ æ­¤å¤„å¯æ”¾ç½®å¾®å‰ç«¯é¡¹ç›®ä¸­çš„å…¬å…±æ¨¡å— --> 
      <script type="systemjs-importmap">
        {
          "imports": {
            "single-spa": "https://cdn.jsdelivr.net/npm/single- spa@5.8.3/lib/system/single-spa.min.js"
          }
        }
      </script>
      ```

      ğŸ“¢ single-spa æ¡†æ¶å¯ä»¥æ”¯æŒangular.js åˆ° 11ï¼Œç›®å‰å¯¹æœ€æ–°çš„ Anugular 11 æ”¯æŒè¿˜ä¸æ˜¯å¤ªå¥½ï¼Œæ‰€ä»¥ç›®å‰ä¸æ¨èåœ¨ single-spa ä¸­åŠ è½½ æœ€æ–°çš„ angular åº”ç”¨ï¼Œä½†æ˜¯å¯ä»¥åšå…¼å®¹

â˜ [å®Œæ•´ç‰ˆDemo Link](https://github.com/CrystalAngelLee/crystal-micro-frontend/tree/main/container)



## åˆ›å»ºä¸åŸºäºæ¡†æ¶çš„å¾®åº”ç”¨

1. åº”ç”¨åˆå§‹åŒ–ï¼š `mkdir application && cd "$_" `

2. å®‰è£…ä¾èµ–

   ```json
   {
     "name": "application",
     "version": "1.0.0",
     "description": "",
     "main": "webpack.config.js",
     "scripts": {
       "start": "webpack serve"
     },
     "keywords": [],
     "author": "",
     "license": "ISC",
     "dependencies": {
       "@babel/core": "^7.12.10",
       "single-spa": "^5.9.0",
       "webpack": "^5.8.0",
       "webpack-cli": "^4.2.0",
       "webpack-config-single-spa": "^2.0.0",
       "webpack-dev-server": "^4.0.0-beta.0",
       "webpack-merge": "^5.4.0"
     }
   }
   ```

3. é…ç½® webpack

   ```js
   const singleSpaDefaults = require("webpack-config-single-spa")
   const { merge } = require("webpack-merge")
   
   module.exports = () => {
     const defaultConfig = singleSpaDefaults({
       orgName: "study", // ç»„ç»‡åç§°
       projectName: "application" // å¾®åº”ç”¨çš„åå­—
     })
     return merge(defaultConfig, {
       devServer: {
         port: 9001
       }
     })
   }
   ```

4. å»ºç«‹å…¥å£æ–‡ä»¶ï¼Œæ–‡ä»¶åç§°è§„åˆ™ï¼š`ç»„ç»‡åç§°-é¡¹ç›®åç§°` ï¼ˆè¦å’Œé…ç½®çš„åœ°æ–¹å¯¹åº”å“¦~ï¼‰`src/study-application.js`

5. åœ¨åº”ç”¨å…¥å£æ–‡ä»¶ä¸­å¯¼å‡ºå¾®å‰ç«¯åº”ç”¨æ‰€éœ€çš„ç”Ÿå‘½å‘¨æœŸå‡½æ•°ï¼ˆæ˜¯åº”ç”¨çº§åˆ«çš„ç”Ÿå‘½å‘¨æœŸå‡½æ•°å“¦~ï¼‰ï¼Œç”Ÿå‘½å‘¨æœŸå‡½æ•°å¿…é¡»è¿”å› Promise

   ```js
   let div_container = null
   
   export async function bootstrap () {
       console.log('I am starting up...')
   }
   
   export async function mount () {
       console.log("I'm mounting...")
       div_container = document.createElement('div')
       div_container.innerHTML = 'hello world'
       document.body.appendChild(div_container)
   }
   
   export async function unmount () {
       console.log('I will be unmount')
       document.body.removeChild(div_container)
   }
   ```

6. åœ¨ package.json æ–‡ä»¶ä¸­æ·»åŠ åº”ç”¨å¯åŠ¨å‘½ä»¤

   ```json
   "scripts": {
     "start": "webpack serve"
   },
   ```

7. åœ¨å¾®å‰ç«¯å®¹å™¨åº”ç”¨ä¸­æ³¨å†Œå¾®å‰ç«¯åº”ç”¨

   ```js
   registerApplication({
     name: "@study/application",
     app: () => System.import("@study/application"),
     activeWhen: ["/application"]
   })
   ```

8. åœ¨æ¨¡æ¿æ–‡ä»¶ä¸­æŒ‡å®šæ¨¡å—è®¿é—®åœ°å€

   ```ejs
   <script type="systemjs-importmap">
     {
       "imports": {
         "@study/application": "//localhost:9001/study-application.js",
       }
     }
   </script>
   ```

9. ä¿®æ”¹é»˜è®¤åº”ç”¨ä»£ç 

   ```js
   // æ³¨æ„: å‚æ•°çš„ä¼ é€’æ–¹å¼å‘ç”Ÿäº†å˜åŒ–, åŸæ¥æ˜¯ä¼ é€’äº†ä¸€ä¸ªå¯¹è±¡, å¯¹è±¡ä¸­æœ‰ä¸‰é¡¹é…ç½®, ç°åœ¨æ˜¯ä¼ é€’äº†ä¸‰ ä¸ªå‚æ•° 
   registerApplication( 
     "@single-spa/welcome", 
     () => System.import( "https://unpkg.com/single-spa-welcome/dist/single-spa-welcome.js" ), 
     location => location.pathname === "/" 
   )
   ```

â˜ [å®Œæ•´ç‰ˆDemo Link](https://github.com/CrystalAngelLee/crystal-micro-frontend/tree/main/noframe)




## åˆ›å»ºåŸºäº React çš„å¾®åº”ç”¨

1. åˆ›å»ºåº”ç”¨ï¼š create-single-spa
   1. åº”ç”¨ç›®å½•è¾“å…¥ todos
   2. æ¡†æ¶é€‰æ‹© react

2. ä¿®æ”¹åº”ç”¨ç«¯å£ && å¯åŠ¨åº”ç”¨

   ```json
   "scripts": {
       "start": "webpack serve --port 9002",
   }
   ```

3. æ³¨å†Œåº”ç”¨ï¼Œå°† React é¡¹ç›®çš„å…¥å£æ–‡ä»¶æ³¨å†Œåˆ°åŸºåº§åº”ç”¨ä¸­

   ```js
   registerApplication({
     name: "@study/todos",
     app: () => System.import("@study/todos"),
     activeWhen: ["/todos"]
   })
   ```

4. æŒ‡å®šå¾®å‰ç«¯åº”ç”¨æ¨¡å—çš„å¼•ç”¨åœ°å€

   ```ejs
   <!--
   	åœ¨æ³¨å†Œåº”ç”¨æ—¶ systemjs å¼•ç”¨äº† @study/todos æ¨¡å—, æ‰€ä»¥éœ€è¦é…ç½®è¯¥æ¨¡å—çš„å¼•ç”¨åœ°å€
   -->
   <script type="systemjs-importmap">
         {
           "imports": {
             "@study/todos": "//localhost:9002/study-todos.js",
           }
         }
   </script>
   ```

5. æŒ‡å®šå…¬å…±åº“çš„è®¿é—®åœ°å€
   é»˜è®¤æƒ…å†µä¸‹ï¼Œåº”ç”¨ä¸­çš„ react å’Œ react-dom æ²¡æœ‰è¢« webpack æ‰“åŒ…ï¼Œ single-spa è®¤ä¸ºå®ƒæ˜¯å…¬å…±åº“ï¼Œä¸åº”è¯¥å•ç‹¬æ‰“åŒ…ã€‚

   ```ejs
   <script type="systemjs-importmap">
     {
       "imports": {
         "single-spa": "https://cdn.jsdelivr.net/npm/single-spa@5.9.0/lib/system/single-spa.min.js",
         "react": "https://cdn.jsdelivr.net/npm/react@17.0.1/umd/react.production.min.js",
         "react-dom": "https://cdn.jsdelivr.net/npm/react-dom@17.0.1/umd/react-dom.production.min.js",
         "react-router-dom": "https://cdn.jsdelivr.net/npm/react-router-dom@5.2.0/umd/react-router-dom.min.js"
       }
     }
   </script>
   ```

6. å¾®å‰ç«¯ React åº”ç”¨å…¥å£æ–‡ä»¶ä»£ç è§£æ

   ```js
   // reactã€react-dom çš„å¼•ç”¨æ˜¯ index.ejs æ–‡ä»¶ä¸­ import-map ä¸­æŒ‡å®šçš„ç‰ˆæœ¬
   import React from "react"
   import ReactDOM from "react-dom"
   // single-spa-react ç”¨äºåˆ›å»ºä½¿ç”¨ React æ¡†æ¶å®ç°çš„å¾®å‰ç«¯åº”ç”¨
   import singleSpaReact from "single-spa-react"
   // ç”¨äºæ¸²æŸ“åœ¨é¡µé¢ä¸­çš„æ ¹ç»„ä»¶
   import Root from "./root.component"
   
   // åˆ›å»ºåŸºäº React æ¡†æ¶çš„å¾®å‰ç«¯åº”ç”¨, è¿”å›ç”Ÿå‘½å‘¨æœŸå‡½æ•°å¯¹è±¡
   const lifecycles = singleSpaReact({
     React,
     ReactDOM,
     rootComponent: Root,
     // é”™è¯¯è¾¹ç•Œå‡½æ•°
     errorBoundary(err, info, props) {
       // Customize the root error boundary for your microfrontend here.
       return null
     },
     // æŒ‡å®šæ ¹ç»„ä»¶çš„æ¸²æŸ“ä½ç½®
     domElementGetter: () => document.getElementById("root")
   })
   
   // æš´éœ²å¿…è¦çš„ç”Ÿå‘½å‘¨æœŸå‡½æ•°
   export const { bootstrap, mount, unmount } = lifecycles
   
   ```

7. è·¯ç”±é…ç½®

   ```js
   // root.component.js
   import React from "react"
   import Parcel from "single-spa-react/parcel"
   import {
     BrowserRouter,
     Route,
     Link,
     Redirect,
     Switch
   } from "react-router-dom"
   import Home from "./Home"
   import About from "./About"
   
   export default function Root(props) {
     return (
       <BrowserRouter basename="/todos">
         <Parcel config={System.import("@study/navbar")} />
         <div>
           <Link to="/home">Home</Link>
           <Link to="/about">About</Link>
         </div>
         <Switch>
           <Route path="/home">
             <Home />
           </Route>
           <Route path="/about">
             <About />
           </Route>
           <Route path="/">
             <Redirect to="/home" />
           </Route>
         </Switch>
       </BrowserRouter>
     )
   }
   ```

8. ä¿®æ”¹ webpack é…ç½®

   ```js
   const { merge } = require("webpack-merge");
   const singleSpaDefaults = require("webpack-config-single-spa-react");
   
   module.exports = (webpackConfigEnv, argv) => {
     const defaultConfig = singleSpaDefaults({
       orgName: "mic-demo",
       projectName: "reactframe",
       webpackConfigEnv,
       argv,
     });
   
     return merge(defaultConfig, {
       externals: ["react-router-dom"]
     });
   };
   ```

â˜ [å®Œæ•´ç‰ˆDemo Link](https://github.com/CrystalAngelLee/crystal-micro-frontend/tree/main/reactframe)



## åˆ›å»ºåŸºäº Vue çš„å¾®åº”ç”¨

1. åˆ›å»ºåº”ç”¨ï¼š create-single-spa
   1. é¡¹ç›®æ–‡ä»¶å¤¹å¡«å†™ vueframe
   2. æ¡†æ¶é€‰æ‹© Vue
   3. ç”Ÿæˆ Vue 2 é¡¹ç›®

2. ä¿®æ”¹ webpack, æå– vue && vue-router

   ```js
   // touch vue.config.js
   module.exports = {
       chainWebpack: config => {
         config.externals(["vue", "vue-router"])
       }
   }
   ```
   
3. é…ç½®vue && vue-router

   ```ejs
   <script type="systemjs-importmap">
       {
         "imports": {
           "vue": "https://cdn.jsdelivr.net/npm/vue@2.6.10/dist/vue.js",
           "vue-router": "https://cdn.jsdelivr.net/npm/vue-router@3.0.7/dist/vue-router.min.js"
         }
       }
   </script>
   ```

4. ä¿®æ”¹å¯åŠ¨å‘½ä»¤ && å¯åŠ¨åº”ç”¨

   ```json
   "scripts": {
   		"start": "vue-cli-service serve --port 9003",
   }
   ```

5. é…ç½®åˆ°å®¹å™¨åº”ç”¨ä¸­

   ```js
   registerApplication({
     name: "@study/vueframe",
     app: () => System.import("@mic-demo/vueframe"),
     activeWhen: ["/vueframe"]
   });
   ```

   é…ç½®åº”ç”¨åˆ°æ¨¡æ¿ä¸­

   ```ejs
   <script type="systemjs-importmap">
       {
         "imports": {
           "@study/vueframe": "//localhost:9003/js/app.js"
         }
       }
     </script>
   ```

6. å–æ¶ˆè®¿é—®é™åˆ¶

   ```ejs
   // æ³¨é‡Šæ‰è¿™ä¸€å¥å°±å¥½å•¦~ åœ¨container çš„ index.ejs ä¸­å“¦~
   <meta http-equiv="Content-Security-Policy" content="default-src 'self' https: localhost:*; script-src 'unsafe-inline' 'unsafe-eval' https: localhost:*; connect-src https: localhost:* ws://localhost:*; style-src 'unsafe-inline' https:; object-src 'none';">
   ```

7. Vue åº”ç”¨é…ç½®è·¯ç”±

   ```js
   // main.js
   import Vue from 'vue';
   import VueRouter from "vue-router"
   import singleSpaVue from 'single-spa-vue';
   
   import App from './App.vue';
   
   Vue.use(VueRouter)
   
   Vue.config.productionTip = false;
   
   // ç»„ä»¶
   const Foo = { template: "<div>Foo</div>" }
   const Bar = { template: "<div>Bar</div>" }
   
   // è§„åˆ™
   const routes = [
     { path: "/foo", component: Foo },
     { path: "/bar", component: Bar }
   ]
   
   // å®ä¾‹: è®°ä½è¦é…ç½® base æ˜‚~~
   const router = new VueRouter({ routes, mode: "history", base: "/vueframe" })
   
   const vueLifecycles = singleSpaVue({
     Vue,
     appOptions: {
       // è·¯ç”±
       router,
       // æ¸²æŸ“ç»„ä»¶
       render(h) {
         return h(App, {
           // å‘ç»„ä»¶ä¸­ä¼ é€’æ•°æ®
           props: {
             /*
             name: this.name,
             mountParcel: this.mountParcel,
             singleSpa: this.singleSpa,
             */
           },
         });
       },
     },
   });
   
   // å¯¼å‡ºç”Ÿå‘½å‘¨æœŸå‡½æ•°
   export const bootstrap = vueLifecycles.bootstrap;
   export const mount = vueLifecycles.mount;
   export const unmount = vueLifecycles.unmount;
   ```

   ```vue
   // App.vue
   <template>
     <div id="app">
       <router-link to="/foo">foo</router-link>&nbsp;
       <router-link to="/bar">bar</router-link>
       <router-view></router-view>
     </div>
   </template>
   ```

â˜ [å®Œæ•´ç‰ˆDemo Link](https://github.com/CrystalAngelLee/crystal-micro-frontend/tree/main/vueframe)



## åˆ›å»º Parcel åº”ç”¨

Parcel ç”¨æ¥åˆ›å»ºå…¬å…± UIï¼Œæ¶‰åŠåˆ°è·¨æ¡†æ¶å…±äº« UI æ—¶éœ€è¦ä½¿ç”¨ Parcelã€‚

Parcel çš„å®šä¹‰å¯ä»¥ä½¿ç”¨ä»»ä½• single-spa æ”¯æŒçš„æ¡†æ¶ï¼Œå®ƒä¹Ÿæ˜¯å•ç‹¬çš„åº”ç”¨ï¼Œéœ€è¦å•ç‹¬å¯åŠ¨ï¼Œä½†æ˜¯å®ƒä¸å…³è”è·¯ç”±ã€‚

Parcel åº”ç”¨çš„æ¨¡å—è®¿é—®åœ°å€ä¹Ÿéœ€è¦è¢«æ·»åŠ åˆ° import-map ä¸­ï¼Œå…¶ä»–å¾®åº”ç”¨é€šè¿‡ System.import æ–¹æ³•è¿›è¡Œå¼•ç”¨ã€‚

**æ —å­ ğŸŒ°**

> éœ€æ±‚ï¼šåˆ›å»º navbar parcelï¼Œåœ¨ä¸åŒçš„åº”ç”¨ä¸­ä½¿ç”¨å®ƒã€‚

1. ä½¿ç”¨ React åˆ›å»º Parcel åº”ç”¨

   1. `create-single-spa`

   2. ç¼–è¾‘`navbar/src/root.component.js`

      ```js
      import React from 'react'
      import { Link, BrowserRouter } from 'react-router-dom'
      
      const Navbar = () => {
        return (
          <BrowserRouter>
            <Link to="/">@single-spa/welcome</Link>&nbsp;
            <Link to="/application">@study/application</Link>&nbsp;
            <Link to="/todos">@study/todos</Link>&nbsp;
            <Link to="/vueframe">@study/vueframe</Link>
          </BrowserRouter>
        )
      }
      
      export default Navbar
      ```

   3. ä¿®æ”¹å¯åŠ¨å‘½ä»¤

      ```json
      "scripts": {
          "start": "webpack serve --port 9004",
      }
      ```

2. åœ¨ webpack é…ç½®æ–‡ä»¶ä¸­å»é™¤ react-router-dom

   ```js
   externals: ["react-router-dom"]
   ```

3. å¯åŠ¨åº”ç”¨: `npm start`

4. åœ¨æ¨¡æ¿æ–‡ä»¶ä¸­æŒ‡å®šåº”ç”¨æ¨¡å—åœ°å€

   ```ejs
   {
     "imports": {
     	"@study/navbar": "//localhost:9004/study-navbar.js"
     }
   }
   ```

5. åœ¨ React åº”ç”¨ä¸­ä½¿ç”¨å®ƒ

   ```js
   import Parcel from "single-spa-react/parcel"
   <Parcel config={System.import("@study/navbar")} />
   ```

6. åœ¨ Vue åº”ç”¨ä¸­ä½¿ç”¨å®ƒ

   ```vue
   <Parcel :config="parcelConfig" :mountParcel="mountParcel" />
   <script>
   import Parcel from "single-spa-vue/dist/esm/parcel"
   import { mountRootParcel } from "single-spa"
   export default {
     components: {
     	Parcel
     },
     data() {
       return {
         parcelConfig: window.System.import("@study/navbar"),
         mountParcel: mountRootParcel
       }
     }
   }
   </script>
   ```

   - éœ€è¦æ’é™¤single spa çš„åŒ…

     ```js
     // vue.config.js
     config.externals(["vue", "vue-router", 'single-spa'])
     ```


â˜ [å®Œæ•´ç‰ˆDemo Link](https://github.com/CrystalAngelLee/crystal-micro-frontend/tree/main/navbar)



## åˆ›å»º utility modules

> ç”¨äºæ”¾ç½®è·¨åº”ç”¨å…±äº«çš„ JavaScript é€»è¾‘ï¼Œå®ƒä¹Ÿæ˜¯ç‹¬ç«‹çš„åº”ç”¨ï¼Œéœ€è¦å•ç‹¬æ„å»ºå•ç‹¬å¯åŠ¨ã€‚

1. åˆ›å»ºåº”ç”¨ï¼š `create-single-spa`

   1. æ–‡ä»¶å¤¹å¡«å†™ tools
   2. åº”ç”¨é€‰æ‹© `in-browser utility module (styleguide, api cache, etc)`

2. ä¿®æ”¹ç«¯å£ï¼Œå¯åŠ¨åº”ç”¨

   ```json
   "scripts": {
   	"start": "webpack serve --port 9005",
   }
   ```

3. åº”ç”¨ä¸­å¯¼å‡ºæ–¹æ³•

   ```js
   export function consoleFunc(param) {
       console.log(`%c${param} wahahah~`, "color: skyblue")
   }
   ```

4. åœ¨æ¨¡æ¿æ–‡ä»¶ä¸­å£°æ˜åº”ç”¨æ¨¡å—è®¿é—®åœ°å€

   ```ejs
   <script type="systemjs-importmap">
   {
     "imports": {
     	"@study/tools": "//localhost:9005/study-tools.js"
     }
   }
   </script>
   ```

5. åœ¨ React åº”ç”¨ä¸­ä½¿ç”¨è¯¥æ–¹æ³•

   ```js
   import React, {useState, useEffect} from 'react'
   
   function useToolsModule() {
       const [tools, setTools] = useState()
       useEffect(() => {
           System.import('@study/tools').then(setTools)
       }, [])
       return tools
   }
   
   const Home = () => {
       const tools = useToolsModule();
       if (tools) tools.consoleFunc('react yyds')
       return (
           <div>
               Home
           </div>
       )
   }
   
   export default Home
   ```

6. åœ¨ Vue åº”ç”¨ä¸­ä½¿ç”¨è¯¥æ–¹æ³•

   ```vue
   <template>
     <div id="app">
       ...
       <h2 @click="handleClick">hello a~~</h2>
     </div>
   </template>
   
   <script>
   export default {
     ...
     methods: {
       async handleClick() {
         const toolsModule = await window.System.import("@mic-demo/tools")
         toolsModule.consoleFunc("@mic-demo/vue~~~")
       }
     },
   }
   </script>
   ```

â˜ [å®Œæ•´ç‰ˆDemo Link](https://github.com/CrystalAngelLee/crystal-micro-frontend/tree/main/tools)



## å®ç°è·¨åº”ç”¨é€šä¿¡

> è¦å®ç°è·¨åº”ç”¨é€šä¿¡éœ€è¦å€ŸåŠ© utility modules å’Œ rxJSï¼Œå› ä¸ºåœ¨å¾®å‰ç«¯æ¶æ„çš„åº”ç”¨å½“ä¸­æˆ‘ä»¬é€šå¸¸ä½¿ç”¨å‘å¸ƒè®¢é˜…æ¨¡å¼æ¥å®ç°è·¨åº”ç”¨é€šä¿¡å’ŒçŠ¶æ€å…±äº«çš„ï¼ŒrxJS å°±æ˜¯åŸºäºè¿™æ ·çš„ä¸€ä¸ªè®¾è®¡æ¨¡å¼çš„ï¼Œå¹¶ä¸”å®ƒæ— å…³äºæ¡†æ¶ï¼Œä¹Ÿå°±æ˜¯å¯ä»¥åœ¨ä»»ä½•å…¶ä»–æ¡†æ¶ä¸­ä½¿ç”¨ã€‚

1. åœ¨ index.ejs æ–‡ä»¶ä¸­æ·»åŠ  rxjs çš„ import-map

   ```ejs
   {
         "imports": {
           "rxjs": "https://cdn.jsdelivr.net/npm/rxjs@6.6.3/bundles/rxjs.umd.min.js"
         }
   }
   ```

2. åœ¨ utility modules ä¸­å¯¼å‡ºä¸€ä¸ª ReplaySubjectï¼Œå®ƒå¯ä»¥å¹¿æ’­å†å²æ¶ˆæ¯ï¼Œå°±ç®—åº”ç”¨æ˜¯åŠ¨æ€åŠ è½½è¿›æ¥çš„ï¼Œä¹Ÿå¯ä»¥æ¥æ”¶åˆ°æ•°æ®ã€‚

   ```js
   import { ReplaySubject } from 'rxjs'
   
   export const sharedSubject = new ReplaySubject()
   ```

3. åœ¨ React åº”ç”¨ä¸­è®¢é˜…å®ƒ

   ```js
   useEffect(() => {
       let subjection = null
       if (tools) {
           tools.consoleFunc('react yyds')
           subjection = tools.sharedSubject.subscribe(console.log)
       }
       return () => subjection.unsubscribe()
   }, [])
   ```

4. åœ¨ Vue åº”ç”¨ä¸­è®¢é˜…å®ƒ

   ```js
   async mounted() {
     const toolsModule = await window.System.import("@study/tools")
     toolsModule.sharedSubject.subscribe(console.log)
   }
   ```

5. æ³¨å†Œäº‹ä»¶

   > è¿™é‡Œä½œä¸ºç¤ºä¾‹å°†äº‹ä»¶æ³¨å†Œåˆ°äº†react ç›¸å…³çš„åº”ç”¨ä¸­

   ```js
   <button
     onClick={() => toolsModule.sharedSubject.next("Hello Hello Hello")}
   >
     button
   </button>
   ```

6. éªŒè¯
   ç°åœ¨ä½ å¯ä»¥ç‚¹å‡»button ç„¶åå†æ§åˆ¶å°é‡Œçœ‹ä½ çš„è¾“å‡ºå•¦~



## [Layout Engine(å¸ƒå±€å¼•æ“)](https://single-spa.js.org/docs/layout-overview/)

> å…è®¸ä½¿ç”¨ç»„ä»¶çš„æ–¹å¼å£°æ˜é¡¶å±‚è·¯ç”±(ç±»ä¼¼äº react ä¸­é…ç½®è·¯ç”±çš„æ–¹å¼ï¼šè®¿é—®ä»€ä¹ˆæ ·çš„åœ°å€è·³è½¬ä»€ä¹ˆåº”ç”¨)ï¼Œå¹¶ä¸”æä¾›äº†æ›´åŠ ä¾¿æ·çš„è·¯ç”±APIç”¨æ¥æ³¨å†Œåº”ç”¨ã€‚

1. ä¸‹è½½å¸ƒå±€å¼•æ“ `npm install single-spa-layout`

2. æ„å»ºè·¯ç”±

   ```ejs
   <-- index.ejs -->
   <html>
     <head>
       <template id="single-spa-layout">
         <single-spa-router>
           <nav class="topnav">
             <application name="@study/navbar"></application>
           </nav>
           <div class="main-content">
             <route default>
             	<application name="@single-spa/welcome"></application>
             </route>
             <route path="application">
             <application name="@study/application"></application>
             </route>
             <route path="todos">
             <application name="@study/todos"></application>
             </route>
             <route path="realworld">
             <application name="@study/realworld"></application>
             </route>
           </div>
         </single-spa-router>
       </template>
     </head>
   </html>
   ```

   ```ejs
   // æ³¨å†Œé¦–é¡µ
   {
         "imports": {
           "@single-spa/welcome": "https://unpkg.com/single-spa-welcome/dist/single-spa-welcome.js"
         }
   }
   ```

3. è·å–è·¯ç”±ä¿¡æ¯ && æ³¨å†Œåº”ç”¨

   ```js
   import { registerApplication, start } from "single-spa";
   import { constructApplications, constructRoutes } from "single-spa-layout"
   
   // è·å–è·¯ç”±é…ç½®å¯¹è±¡
   const routes = constructRoutes(document.querySelector("#single-spa-layout"))
   // è·å–è·¯ç”±ä¿¡æ¯æ•°ç»„
   const applications = constructApplications({
     routes,
     loadApp({ name }) {
       return System.import(name)
     }
   })
   // éå†è·¯ç”±ä¿¡æ¯æ³¨å†Œåº”ç”¨
   applications.forEach(registerApplication)
   
   start({
     urlRerouteOnly: true,
   });
   ```




# Module Federation æ¨¡å—è”é‚¦

> é€šè¿‡ æ¨¡å—è”é‚¦ ä¹Ÿå¯ä»¥å®ç°å¾®å‰ç«¯æ¶æ„

## æ¦‚è¿°

Module Federation å³ä¸ºæ¨¡å—è”é‚¦ï¼Œæ˜¯ Webpack 5 ä¸­æ–°å¢çš„ä¸€é¡¹åŠŸèƒ½ï¼Œå¯ä»¥å®ç°è·¨åº”ç”¨å…±äº«æ¨¡å—ã€‚

```tex
æˆ‘ä»¬æœ‰ä¸¤ä¸ªåº”ç”¨ï¼šAåº”ç”¨å’ŒBåº”ç”¨ã€‚
Aåº”ç”¨ä¸­æä¾›äº†ä¸€ä¸ªæ–¹æ³•ï¼šsayHelloFromA
Båº”ç”¨ä¸­æä¾›äº†ä¸€ä¸ªæ–¹æ³•ï¼šsayHelloFromB
æˆ‘ä»¬æƒ³è¦åœ¨Aåº”ç”¨ä¸­è°ƒç”¨Båº”ç”¨æä¾›çš„æ–¹æ³•ï¼ŒBåº”ç”¨è°ƒç”¨Aåº”ç”¨æä¾›çš„æ–¹æ³•ã€è·¨åº”ç”¨è°ƒç”¨æ–¹æ³•ã€‘
æˆ‘ä»¬å¯ä»¥æŠŠä¸€ä¸ªåº”ç”¨å½“åšä¸€ä¸ªæ¨¡å—ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥åœ¨ä¸€ä¸ªåº”ç”¨ä¸­åŠ è½½å¦ä¸€ä¸ªåº”ç”¨äº†ï¼Œåªè¦æˆ‘ä»¬å¯ä»¥åœ¨ä¸€ä¸ªåº”ç”¨ä¸­åŠ è½½å¦ä¸€ä¸ªåº”ç”¨æˆ‘ä»¬å°±å¯ä»¥å®ç°å¾®å‰ç«¯æ¶æ„
```

![image-20211103113005914](./images/module-federation.png)



## å¿«é€Ÿä¸Šæ‰‹

> éœ€æ±‚ï¼šé€šè¿‡æ¨¡å—è”é‚¦åœ¨å®¹å™¨åº”ç”¨ä¸­åŠ è½½å¾®åº”ç”¨

   ![image-20211103143813562](./images/module-demo.png)

### 1. **åˆ›å»ºåº”ç”¨ç»“æ„**
   æŒ‰ç…§ä»¥ä¸‹ç›®å½•ç»“æ„æ„å»ºå¥½ä¸‰ä¸ªå¾®åº”ç”¨çš„åº”ç”¨ç»“æ„ï¼Œ`package.json` å’Œ `package-lock.json` æ–‡ä»¶åˆå§‹ä½“éªŒå¯ä»¥ç›´æ¥ copy å®Œæˆdemo ä¸­çš„æ–‡ä»¶
   html ä¸­åˆå§‹åŒ–å¥½å„è‡ªçš„å†…å®¹
   å®‰è£…å„è‡ªçš„ä¾èµ–

   ```bash
   products
   â”œâ”€â”€ package-lock.json
   â”œâ”€â”€ package.json
   â”œâ”€â”€ public       // é™æ€èµ„æºæ–‡ä»¶
   â”‚   â””â”€â”€ index.html
   â”œâ”€â”€ src          // æºç 
   â”‚   â””â”€â”€ index.js
   â””â”€â”€ webpack.config.js
   ```

### 2. **åº”ç”¨åˆå§‹åŒ–**

   1. åœ¨å…¥å£ JavaScript æ–‡ä»¶ä¸­åŠ å…¥äº§å“åˆ—è¡¨
   
      ```js
      // faker å¯ä»¥ç”¨æ¥éšæœºç”Ÿæˆæ•°æ®
      import faker from 'faker'
      
      let products = '';
      
      for (let i = 1; i <= 5; i++) {
          products += `<div>${faker.commerce.productName()}</div>`
      }
      
      document.querySelector("#products").innerHTML = products
      ```
   
   2. åœ¨å…¥å£ html æ–‡ä»¶ä¸­åŠ å…¥ç›’å­
   
      ```html
      <div id="products"></div>
      ```
   
   3. webpack é…ç½®
   
      ```js
      const HtmlWebpackPlugin = require("html-webpack-plugin")
      
      module.exports = {
          mode: "development",
          devServer: {
              port: 8081
          },
          plugins: [
              new HtmlWebpackPlugin({
                  template: "./public/index.html"
              })
          ]
      }
      ```
   
   4. æ·»åŠ åº”ç”¨å¯åŠ¨å‘½ä»¤
   
      ```json
      "scripts": {
          "start": "webpack serve"
      },
      ```
   
   5. é€šè¿‡ copy çš„æ–¹å¼åˆ›å»º container å’Œ cart

### 3. **Module Federation**

   é€šè¿‡é…ç½®æ¨¡å—è”é‚¦å®ç°åœ¨å®¹å™¨åº”ç”¨ä¸­åŠ è½½äº§å“åˆ—è¡¨å¾®åº”ç”¨ã€‚

   1. åœ¨äº§å“åˆ—è¡¨å¾®åº”ç”¨ä¸­å°†è‡ªèº«ä½œä¸ºæ¨¡å—è¿›è¡Œå¯¼å‡º
   
      ```js
      // webpack.config.js
      // å¯¼å…¥æ¨¡å—è”é‚¦æ’ä»¶
      const ModuleFederationPlugin = require("webpack/lib/container/ModuleFederationPlugin");
      // å°† products è‡ªèº«å½“åšæ¨¡å—æš´éœ²å‡ºå»
      new ModuleFederationPlugin({
        // æ¨¡å—æ–‡ä»¶åç§°, å…¶ä»–åº”ç”¨å¼•å…¥å½“å‰æ¨¡å—æ—¶éœ€è¦åŠ è½½çš„æ–‡ä»¶çš„åå­—
        filename: "remoteEntry.js",
        // æ¨¡å—åç§°, å…·æœ‰å”¯ä¸€æ€§, ç›¸å½“äº single-spa ä¸­çš„ç»„ç»‡åç§°
        name: "products",
        // å½“å‰æ¨¡å—å…·ä½“å¯¼å‡ºçš„å†…å®¹
        exposes: { "./index": "./src/index" },
      });
      // åœ¨å®¹å™¨åº”ç”¨ä¸­è¦å¦‚ä½•å¼•å…¥äº§å“åˆ—è¡¨åº”ç”¨æ¨¡å—?
      // 1. åœ¨å®¹å™¨åº”ç”¨ä¸­åŠ è½½äº§å“åˆ—è¡¨åº”ç”¨çš„æ¨¡å—æ–‡ä»¶
      // 2. åœ¨å®¹å™¨åº”ç”¨ä¸­é€šè¿‡ import å…³é”®å­—ä»æ¨¡å—æ–‡ä»¶ä¸­å¯¼å…¥äº§å“åˆ—è¡¨åº”ç”¨æ¨¡å—
      ```

   2. åœ¨å®¹å™¨åº”ç”¨çš„ä¸­å¯¼å…¥äº§å“åˆ—è¡¨å¾®åº”ç”¨
   
      ```js
      // webpack.config.js
      // å¯¼å…¥æ¨¡å—è”é‚¦æ’ä»¶
      const ModuleFederationPlugin = require("webpack/lib/container/ModuleFederationPlugin");
      new ModuleFederationPlugin({
        name: "container",
        // é…ç½®å¯¼å…¥æ¨¡å—æ˜ å°„
        remotes: {
          // å­—ç¬¦ä¸² "products" å’Œè¢«å¯¼å…¥æ¨¡å—çš„ name å±æ€§å€¼å¯¹åº”
          // å±æ€§ products æ˜¯æ˜ å°„åˆ«å, æ˜¯åœ¨å½“å‰åº”ç”¨ä¸­å¯¼å…¥è¯¥æ¨¡å—æ—¶ä½¿ç”¨çš„åå­—
          products: "products@http://localhost:8081/remoteEntry.js",
        },
      });
      ```
   
      ```js
      // src/index.js 
      // å› ä¸ºæ˜¯ä»å¦ä¸€ä¸ªåº”ç”¨ä¸­åŠ è½½æ¨¡å—, è¦å‘é€è¯·æ±‚æ‰€ä»¥ä½¿ç”¨å¼‚æ­¥åŠ è½½æ–¹å¼ 
      import("products/index").then(products => console.log(products))
      ```
   
      é€šè¿‡ä¸Šé¢è¿™ç§æ–¹å¼åŠ è½½åœ¨å†™æ³•ä¸Šå¤šäº†ä¸€å±‚å›è°ƒå‡½æ•°, ä¸æ˜¯å¾ˆæ–¹ä¾¿, æ‰€ä»¥ä¸€èˆ¬éƒ½ä¼šåœ¨ src æ–‡ä»¶å¤¹ä¸­å»ºç«‹bootstrap.jsï¼Œåœ¨å½¢å¼ä¸Šå°†å†™æ³•å˜ä¸ºåŒæ­¥
   
      ```js
      // src/index.js 
      import('./bootstrap.js') 
      
      // src/bootstrap.js 
      import "products/index"
      ```

3. å®ç° Cart å¾®åº”ç”¨åŠ è½½
   æ³¨æ„:cart/index.html å’Œ products/index.html ä»…ä»…æ˜¯åœ¨å¼€å‘é˜¶æ®µä¸­å„è‡ªå›¢é˜Ÿä½¿ç”¨çš„æ–‡ä»¶ï¼Œè€Œ container/index.html æ˜¯åœ¨å¼€å‘é˜¶æ®µå’Œç”Ÿäº§é˜¶æ®µéƒ½è¦ä½¿ç”¨çš„æ–‡ä»¶ã€‚



## å…±äº«æ¨¡å—

### å®ç°æ¨¡å—å…±äº«

åœ¨ Products å’Œ Cart ä¸­éƒ½éœ€è¦ Fakerï¼Œå½“ Container åŠ è½½äº†è¿™ä¸¤ä¸ªæ¨¡å—åï¼ŒFaker è¢«åŠ è½½äº†ä¸¤æ¬¡ã€‚

![image-20211229204834807](./images/å…±äº«æ¨¡å—å¤šæ¬¡åŠ è½½.png)

```js
// åˆ†åˆ«åœ¨ Products å’Œ Cart çš„ webpack é…ç½®æ–‡ä»¶ä¸­çš„æ¨¡å—è”é‚¦æ’ä»¶ä¸­æ·»åŠ ä»¥ä¸‹ä»£ç  
// å¦‚æœé‡åˆ°ç‰ˆæœ¬ä¸ä¸€è‡´çš„é—®é¢˜ï¼Œå¼ºåˆ¶ä½¿ç”¨é«˜ç‰ˆæœ¬
{
  shared: ["faker"]
}
// é‡æ–°å¯åŠ¨ Containerã€Productsã€Cart
```

æ³¨æ„:å…±äº«æ¨¡å—éœ€è¦å¼‚æ­¥åŠ è½½ï¼Œåœ¨ Products å’Œ Cart ä¸­éœ€è¦æ·»åŠ  bootstrap.js

### å…±äº«æ¨¡å—ç‰ˆæœ¬å†²çªè§£å†³

Cart ä¸­å¦‚æœä½¿ç”¨ 4.1.0 ç‰ˆæœ¬çš„ fakerï¼ŒProducts ä¸­ä½¿ç”¨ 5.2.0 ç‰ˆæœ¬çš„ fakerï¼Œé€šè¿‡æŸ¥çœ‹ç½‘ç»œæ§åˆ¶é¢æ¿å¯ä»¥å‘ç° faker åˆä¼šè¢«åŠ è½½äº†ä¸¤æ¬¡ï¼Œæ¨¡å—å…±äº«å¤±è´¥ã€‚
è§£å†³åŠæ³•æ˜¯åˆ†åˆ«åœ¨ Products å’Œ Cart ä¸­çš„ webpack é…ç½®ä¸­åŠ å…¥å¦‚ä¸‹ä»£ç 

```js
shared: {
  faker: {
    singleton: true
  }
}
```

ä½†åŒæ—¶ä¼šåœ¨åŸæœ¬ä½¿ç”¨ä½ç‰ˆæœ¬çš„å…±äº«æ¨¡å—åº”ç”¨çš„æ§åˆ¶å°ä¸­ç»™äºˆè­¦å‘Šæç¤ºã€‚

###  å¼€æ”¾å­åº”ç”¨æŒ‚è½½æ¥å£

åœ¨å®¹å™¨åº”ç”¨å¯¼å…¥å¾®åº”ç”¨åï¼Œåº”è¯¥æœ‰æƒé™å†³å®šå¾®åº”ç”¨çš„æŒ‚è½½ä½ç½®ï¼Œè€Œä¸æ˜¯å¾®åº”ç”¨åœ¨ä»£ç è¿è¡Œæ—¶ç›´æ¥è¿›è¡ŒæŒ‚ è½½ã€‚æ‰€ä»¥æ¯ä¸ªå¾®åº”ç”¨éƒ½åº”è¯¥å¯¼å‡ºä¸€ä¸ªæŒ‚è½½æ–¹æ³•ä¾›å®¹å™¨åº”ç”¨è°ƒç”¨ã€‚

[Products/bootstrap.js](https://github.com/CrystalAngelLee/crystal-micro-frontend/tree/main/products/src)

```js
// faker å¯ä»¥ç”¨æ¥éšæœºç”Ÿæˆæ•°æ®
import faker from "faker";

function mount(el) {
  let products = "";

  for (let i = 1; i <= 5; i++) {
    products += `<div>${faker.commerce.productName()}</div>`;
  }

  el.innerHTML = products;
}

// æ­¤å¤„ä»£ç æ˜¯ products åº”ç”¨åœ¨æœ¬åœ°å¼€å‘ç¯å¢ƒä¸‹æ‰§è¡Œçš„
if (process.env.NODE_ENV === "development") {
  const el = document.querySelector("#dev-products");
  // å½“å®¹å™¨åº”ç”¨åœ¨æœ¬åœ°å¼€å‘ç¯å¢ƒä¸‹æ‰§è¡Œæ—¶ä¹Ÿå¯ä»¥è¿›å…¥åˆ°ä»¥ä¸Šè¿™ä¸ªåˆ¤æ–­, å®¹å™¨åº”ç”¨åœ¨æ‰§è¡Œå½“å‰ä»£ç æ—¶è‚¯å®šæ˜¯è· å–ä¸åˆ° dev-products å…ƒç´ çš„, æ‰€ä»¥æ­¤å¤„è¿˜éœ€è¦å¯¹ el è¿›è¡Œåˆ¤æ–­.
  if (el) mount(el);
}
export { mount };
```

[Products/webpack.config.js](https://github.com/CrystalAngelLee/crystal-micro-frontend/blob/main/products/webpack.config.js)

```js
exposes: {
  // ./src/index => ./src/bootstrap ä¸ºä»€ä¹ˆ ?
  // mount æ–¹æ³•æ˜¯åœ¨ bootstrap.js æ–‡ä»¶ä¸­å¯¼å‡ºçš„, æ‰€ä»¥æ­¤å¤„è¦å¯¼å‡º bootstrap
  // æ­¤å¤„çš„å¯¼å‡ºæ˜¯ç»™å®¹å™¨åº”ç”¨ä½¿ç”¨çš„, å’Œå½“å‰åº”ç”¨çš„æ‰§è¡Œæ²¡æœ‰å…³ç³», å½“å‰åº”ç”¨åœ¨æ‰§è¡Œæ—¶ä¾ç„¶å…ˆæ‰§è¡Œ index
  "./Index": "./src/bootstrap",
},
```

[Container/bootstrap.js](https://github.com/CrystalAngelLee/crystal-micro-frontend/tree/main/fedcontainer)

```js
import { mount as mountProducts } from "products/Index";
mountProducts(document.querySelector("dev-products"));
```



## åŸºäºæ¨¡å—è”é‚¦çš„å¾®å‰ç«¯å®ç°æ–¹æ¡ˆ

### åº”ç”¨æ¡ˆä¾‹æ¦‚è¿°

å½“å‰æ¡ˆä¾‹ä¸­åŒ…å«ä¸‰ä¸ªå¾®åº”ç”¨ï¼Œåˆ†åˆ«ä¸º Marketingã€Authentication å’Œ Dashboard

1. Marketing: è¥é”€å¾®åº”ç”¨ï¼ŒåŒ…å«é¦–é¡µç»„ä»¶å’Œä»·æ ¼ç»„ä»¶ 
2. Authentication:èº«ä»½éªŒè¯å¾®åº”ç”¨ï¼ŒåŒ…å«ç™»å½•ç»„ä»¶ 
3. Dashboard:ä»ªè¡¨ç›˜å¾®åº”ç”¨ï¼ŒåŒ…å«ä»ªè¡¨ç›˜ç»„ä»¶

å®¹å™¨åº”ç”¨ã€è¥é”€åº”ç”¨ã€èº«ä»½éªŒè¯åº”ç”¨ä½¿ç”¨ React æ¡†æ¶ï¼Œä»ªè¡¨ç›˜åº”ç”¨ä½¿ç”¨ Vue æ¡†æ¶ã€‚

### Marketing

#### åº”ç”¨åˆå§‹åŒ–

**1. åˆ›å»ºåº”ç”¨ç»“æ„**

```tex
â”œâ”€â”€ public
â”‚ â””â”€â”€ index.html 
â”œâ”€â”€ src
â”‚ â”œâ”€â”€ bootstrap.js
â”‚ â””â”€â”€ index.js
â”œâ”€â”€ package-lock.json
â”œâ”€â”€ package.json
â””â”€â”€ webpack.config.js
```

index.html

```html
<title>Marketing</title>
<div id="dev-marketing"></div>
```

index.js

```js
import("./bootstrap")
```

bootstrap.js

```js
console.log('æµ‹è¯•ç”¨ä¾‹')
```

**2. é…ç½® webpack**

```js
const HtmlWebpackPlugin = require("html-webpack-plugin")

module.exports = {
  mode: "development",
  devServer: {
    port: 8081,
    // å½“ä½¿ç”¨ HTML5 History API æ—¶, æ‰€æœ‰çš„ 404 è¯·æ±‚éƒ½ä¼šå“åº” index.html æ–‡ä»¶
    historyApiFallback: true
  },
  module: {
    rules: [
      {
        test: /\.js$/,
        exclude: /node_modules/,
        use: {
          loader: "babel-loader",
          options: {
            presets: ["@babel/preset-react", "@babel/preset-env"],
            // 1. é¿å… babel è½¬ä¹‰è¯­æ³•å helper å‡½æ•°é‡å¤
						// 2. é¿å… babel polyfill å°† API æ·»åŠ åˆ°å…¨å±€
            plugins: ["@babel/plugin-transform-runtime"]
          }
        }
      }
    ]
  },
  plugins: [
    new HtmlWebpackPlugin({
      template: "./public/index.html"
    })
  ]
}
```

**3. æ·»åŠ å¯åŠ¨å‘½ä»¤**

```js
"scripts": {
  "start": "webpack serve"
}
```



#### åˆ›å»ºæŒ‚è½½æ–¹æ³•

bootstrap.js

```js
import React from "react"
import ReactDOM from "react-dom"

function mount(el) {
  ReactDOM.render(<div>test</div>, el)
}

if (process.env.NODE_ENV === "development") {
  const el = document.querySelector("#dev-marketing")
  if (el) mount(el)
}

export { mount }
```



#### åˆ›å»ºè·¯ç”±

1. åœ¨ src æ–‡ä»¶å¤¹ä¸­åˆ›å»º components æ–‡ä»¶å¤¹ç”¨äºæ”¾ç½®é¡µé¢ç»„ä»¶
2. åœ¨ src æ–‡ä»¶å¤¹ä¸­åˆ›å»º App ç»„ä»¶ï¼Œç”¨äºç¼–å†™è·¯ç”±

App.js

```js
import React from "react"
import { BrowserRouter, Route, Switch } from "react-router-dom"
import Landing from "./components/Landing"
import Pricing from "./components/Pricing"

function App() {
  return (
    <BrowserRouter>
      <Switch>
        <Route path="/pricing">
          <Pricing />
        </Route>
        <Route path="/">
          <Landing />
        </Route>
      </Switch>
    </BrowserRouter>
  )
}

export default App
```

```js
// bootstrap.js
import App from "./App"
function mount(el) { 
  ReactDOM.render(<App />, el)
}
```



### Container

#### åº”ç”¨åˆå§‹åŒ–

**1. åˆ›å»ºåº”ç”¨ç»“æ„ (åŸºäº Marketing åº”ç”¨è¿›è¡Œæ‹·è´ä¿®æ”¹)**

```tex
â”œâ”€â”€ public
â”‚ â””â”€â”€ index.html 
â”œâ”€â”€ src
â”‚ â”œâ”€â”€ bootstrap.js
â”‚ â””â”€â”€ index.js
â”œâ”€â”€ package-lock.json
â”œâ”€â”€ package.json
â””â”€â”€ webpack.config.js
```

**2. ä¿®æ”¹ index.html**

```html
<title>Container</title>
<div id="root"></div>
```

**3. ä¿®æ”¹ App.js**

```js
import React from "react"
export default function App() {
  return <div>Container works</div>
}
```

**4. ä¿®æ”¹ bootstrap.js**

```js
if (process.env.NODE_ENV === "development") { 
  const el = document.querySelector("#root") 
	if (el) mount(el)
}
```

**5. ä¿®æ”¹ webpack.config.js**

```js
module.exports = { 
  devServer: {
		port: 8080 
  }
}
```



#### **åŠ è½½** Marketing

**1. Marketing åº”ç”¨é…ç½® ModuleFederation**

```js
const ModuleFederationPlugin = require("webpack/lib/container/ModuleFederationPlugin")
new ModuleFederationPlugin({ 
  name: "marketing", 
  filename: "remoteEntry.js", 
  exposes: {
		"./MarketingApp": "./src/bootstrap" 
  }
})
```

**2. Container åº”ç”¨é…ç½® ModuleFederation**

```js
const ModuleFederationPlugin =
require("webpack/lib/container/ModuleFederationPlugin")
new ModuleFederationPlugin({
  name: "container",
  remotes: {
		marketing: "marketing@http://localhost:8081/remoteEntry.js" 
  }
})
```

**3. åœ¨ Container åº”ç”¨ä¸­æ–°å»º MarketingApp ç»„ä»¶ï¼Œç”¨äºæŒ‚è½½ Marketing åº”ç”¨**

```js
// Container/components/MarketingApp.js
import React, { useRef, useEffect } from "react"
import { mount } from "marketing/MarketingApp"
export default function MarketingApp() {
  const ref = useRef()
  useEffect(() => {
		mount(ref.current) 
  }, [])
  return <div ref={ref}></div>
}
```

**4. åœ¨ Container åº”ç”¨ä¸­çš„ App ç»„ä»¶ä¸­æ¸²æŸ“ Marketing åº”ç”¨çš„**

```js
// Container/App.js
import React from "react"
import MarketingApp from "./components/MarketingApp"
export default function App() {
  return <MarketingApp />
}
```



### å…±äº«åº“è®¾ç½®

åœ¨ Container åº”ç”¨å’Œ Marketing åº”ç”¨ä¸­éƒ½ä½¿ç”¨äº†å¤§é‡çš„ç›¸åŒçš„ä»£ç åº“ï¼Œå¦‚æœä¸åšå…±äº«å¤„ç†ï¼Œåˆ™åº”ç”¨ä¸­ç›¸åŒçš„å…±äº«åº“ä¼šè¢«åŠ è½½ä¸¤æ¬¡ã€‚

```json
"dependencies": { 
  "@material-ui/core": "^4.11.0", 
  "@material-ui/icons": "^4.9.1", 
  "react": "^17.0.1", 
  "react-dom": "^17.0.1", 
  "react-router-dom": "^5.2.0"
}
```

åœ¨ Container åº”ç”¨å’Œ Marketing åº”ç”¨çš„ webpack é…ç½®æ–‡ä»¶ä¸­åŠ å…¥ä»¥ä¸‹ä»£ç 

```js
const packageJson = require("./package.json")
new ModuleFederationPlugin({ 
  shared: packageJson.dependencies
})
```



### è·¯ç”±é…ç½®

#### **æ¦‚è¿°**

å®¹å™¨åº”ç”¨è·¯ç”±ç”¨äºåŒ¹é…å¾®åº”ç”¨ï¼Œå¾®åº”ç”¨è·¯ç”±ç”¨äºåŒ¹é…ç»„ä»¶ã€‚

å®¹å™¨åº”ç”¨ä½¿ç”¨ BrowserHistory è·¯ç”±ï¼Œå¾®åº”ç”¨ä½¿ç”¨ MemoryHistory è·¯ç”±ã€‚

1. ä¸ºé˜²æ­¢å®¹å™¨åº”ç”¨å’Œå¾®åº”ç”¨åŒæ—¶æ“ä½œ url è€Œäº§ç”Ÿå†²çªï¼Œåœ¨å¾®å‰ç«¯æ¶æ„ä¸­ï¼Œåªå…è®¸å®¹å™¨åº”ç”¨æ›´æ–° urlï¼Œ å¾®åº”ç”¨ä¸å…è®¸æ›´æ–° urlï¼ŒMemoryHistory æ˜¯åŸºäºå†…å­˜çš„è·¯ç”±ï¼Œä¸ä¼šæ”¹å˜æµè§ˆå™¨åœ°å€æ ä¸­çš„ urlã€‚

2. å¦‚æœä¸åŒçš„åº”ç”¨ç¨‹åºéœ€è¦ä¼ è¾¾æœ‰å…³è·¯ç”±çš„ç›¸å…³ä¿¡æ¯ï¼Œåº”è¯¥å°½å¯èƒ½çš„ä½¿ç”¨é€šè¿‡çš„æ–¹å¼ï¼Œ memoryHistory åœ¨ React å’Œ Vue ä¸­éƒ½æœ‰æä¾›ã€‚

#### **æ›´æ–°ç°æœ‰è·¯ç”±é…ç½®**

**1. å®¹å™¨åº”ç”¨çš„è·¯ç”±é…ç½®**

```js
// Container/App.js
import { Router, Route, Switch } from "react-router-dom" 
import { createBrowserHistory } from "history"
const history = createBrowserHistory()
export default function App() {
  return (
    <Router history={history}>
      <Switch>
        <Route path="/">
          <MarketingApp />
        </Route>
      </Switch>
		</Router>
) }
```

**2. Marketing åº”ç”¨çš„è·¯ç”±é…ç½®**

```js
// Marketing/bootstrap.js
import { createMemoryHistory } from "history"
function mount(el) {
  const history = createMemoryHistory() 
  ReactDOM.render(<App history={history} />, el)
}
```

```js
// Marketing/app.js
import { Router, Route, Switch } from "react-router-dom"
export default function App({ history }) {
  return (
    <Router history={history}>
      <Switch>
        <Route path="/pricing" component={Pricing} />
        <Route path="/" component={Landing} />
      </Switch>
		</Router>
) }
```

**3. æ·»åŠ å¤´éƒ¨ç»„ä»¶**

```js
import Header from "./components/Header"
export default function App() {
  return <Header />
}
```

#### å¾®åº”ç”¨å’Œå®¹å™¨åº”ç”¨è·¯ç”±æ²Ÿé€š
1. å¾®åº”ç”¨è·¯ç”±å˜åŒ–æ—¶ url åœ°å€æ²¡æœ‰è¢«åŒæ­¥åˆ°æµè§ˆå™¨çš„åœ°å€æ ä¸­ï¼Œè·¯ç”±å˜åŒ–ä¹Ÿæ²¡æœ‰è¢«åŒæ­¥åˆ°æµè§ˆå™¨çš„å†å²è®°å½•ä¸­ã€‚
   å½“å¾®åº”ç”¨è·¯ç”±å‘ç”Ÿå˜åŒ–æ—¶é€šçŸ¥å®¹å™¨åº”ç”¨æ›´æ–°è·¯ç”±ä¿¡æ¯ (å®¹å™¨åº”ç”¨å‘å¾®åº”ç”¨ä¼ é€’æ–¹æ³•)ã€‚

   ```js
   // Container/components/MarketingApp.js
   import { useHistory } from "react-router-dom"
   const history = useHistory()
   mount(ref.current, {
     onNavigate({ pathname: nextPathname }) {
       const { pathname } = history.location 
       if (pathname !== nextPathname) {
         history.push(nextPathname) 
       }
     } 
   })
   ```

   ```js
   // Marketing/bootstrap.js
   function mount(el, { onNavigate }) {
   	if (onNavigate) history.listen(onNavigate)
   }
   ```

2. å®¹å™¨åº”ç”¨è·¯ç”±å‘ç”Ÿå˜åŒ–æ—¶åªèƒ½åŒ¹é…åˆ°å¾®åº”ç”¨ï¼Œå¾®åº”ç”¨è·¯ç”±å¹¶ä¸ä¼šå“åº”å®¹å™¨åº”ç”¨è·¯ç”±çš„å˜åŒ–ã€‚ å½“å®¹å™¨åº”ç”¨è·¯ç”±å‘ç”Ÿå˜åŒ–æ—¶éœ€è¦é€šçŸ¥å¾®åº”ç”¨è·¯ç”±è¿›è¡Œå“åº” (å¾®åº”ç”¨å‘å®¹å™¨åº”ç”¨ä¼ é€’æ–¹æ³•)

   ```js
   // Marketing/bootstrap.js
   function mount(el, { onNavigate }) {
     return {
       onParentNavigate({ pathname: nextPathname }) {
         const pathname = history.location.pathname;
         if (nextPathname !== pathname) {
           history.push(nextPathname);
         }
       },
     };
   }
   ```

   ```js
   // Container/components/MarketingApp.js
   const { onParentNavigate } = mount(...)
   if (onParentNavigate) history.listen(onParentNavigate);
   ```



#### Marketing åº”ç”¨æœ¬åœ°è·¯ç”±è®¾ç½®

ç›®å‰ Marketing åº”ç”¨æœ¬åœ°å¼€å‘ç¯å¢ƒæ˜¯æŠ¥é”™çš„ï¼ŒåŸå› æ˜¯æœ¬åœ°å¼€å‘ç¯å¢ƒåœ¨è°ƒç”¨ mount æ–¹æ³•æ—¶æ²¡æœ‰ä¼ é€’ç¬¬äºŒä¸ªå‚æ•°ï¼Œé»˜è®¤å€¼å°±æ˜¯ undefined, mount æ–¹æ³•å†…éƒ¨è¯•å›¾ä» undefined ä¸­è§£æ„ onNavigateï¼Œæ‰€ä»¥å°±æŠ¥é”™äº†ã€‚è§£å†³åŠæ³•æ˜¯åœ¨æœ¬åœ°å¼€å‘ç¯å¢ƒè°ƒç”¨mount æ–¹æ³•æ—¶ä¼ é€’ä¸€ä¸ªç©ºå¯¹è±¡ã€‚

```js
if (process.env.NODE_ENV === "development") {
  // ...
  if (el)
    mount(el, {});
}
```

å¦‚æœå½“å‰ä¸ºæœ¬åœ°å¼€å‘ç¯å¢ƒï¼Œè·¯ç”±ä¾ç„¶ä½¿ç”¨ BrowserHistoryï¼Œæ‰€ä»¥åœ¨è°ƒç”¨ mount æ–¹æ³•æ—¶ä¼ é€’ defaultHistory ä»¥åšåŒºåˆ†ã€‚

```js
// Marketing/bootstrap.js
if (process.env.NODE_ENV === "development") {
  // ...
  if (el)
    mount(el, {
      defaultHistory: createBrowserHistory(),
    });
}
```

åœ¨ mount æ–¹æ³•å†…éƒ¨åˆ¤æ–­ defaultHistory æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨å°±ç”¨ defaultHistoryï¼Œå¦åˆ™å°±ç”¨MemoryHistoryã€‚

```js
// Marketing/bootstrap.js
function mount(el, { onNavigate, defaultHistory }) {
  const history = defaultHistory || createMemoryHistory()
}
```



### Authentication

#### åº”ç”¨åˆå§‹åŒ–

**1. æ‹·è´ src æ–‡ä»¶å¤¹å¹¶åšå¦‚ä¸‹ä¿®æ”¹**

```js
// bootstrap.js
if (process.env.NODE_ENV === "development") { 
  const el = document.querySelector("#dev-auth")
}
```

```js
 
// App.js
import React from "react"
import { Router, Route, Switch } from "react-router-dom"
export default function App({ history }) {
  return (
    <Router history={history}>
      <Switch>
        <Route path="/auth/signin" component={Signin}></Route>
      </Switch>
		</Router>
	) 
}
```

**2. æ‹·è´ public æ–‡ä»¶å¤¹ï¼Œå¹¶ä¿®æ”¹ index.html**

```html
<div id="dev-auth"></div>
```

**3. æ‹·è´ webpack.config.js æ–‡ä»¶å¹¶è¿›è¡Œä¿®æ”¹**

```js
module.exports = { 
  devServer: {
		port: 8082 
  },
  plugins: [
    new ModuleFederationPlugin({
      name: "auth",
      exposes: {
				"./AuthApp": "./src/bootstrap" 
      }
		}) 
  ]
}
```

**4. æ·»åŠ åº”ç”¨å¯åŠ¨å‘½ä»¤**

```json
// package.json
"scripts": {
  "start": "webpack serve"
}
```

**5. ä¿®æ”¹ publicPath æ›´æ­£æ–‡ä»¶çš„è®¿é—®è·¯å¾„**

```js
// webpack.config.js
module.exports = { 
  output: {
    publicPath: "http://localhost:8082/"
  }
}
```

**6. æ›´æ­£å…¶ä»–å¾®åº”ç”¨çš„ publicPath**

```js
// Container/webpack.config.js
output: {
  publicPath: "http://localhost:8080/"
}
```

```js
// Marketing/webpack.config.js
output: {
  publicPath: "http://localhost:8081/"
}
```



#### Container åº”ç”¨åŠ è½½ AuthApp

**1. åœ¨ Container åº”ç”¨çš„ webpack ä¸­é…ç½®æ·»åŠ  AuthApp çš„è¿œç«¯åœ°å€**

```js
// Container/webpack.config.js
remotes: {
	auth: "auth@http://localhost:8082/remoteEntry.js"
}
```

**2. åœ¨ Container åº”ç”¨çš„ components æ–‡ä»¶å¤¹ä¸­æ–°å»º AuthApp.jsï¼Œå¹¶æ‹·è´ MarketingApp.js ä¸­çš„å†…å®¹è¿›è¡Œä¿®æ”¹**

```js
import { mount } from "auth/AuthApp"
export default function AuthApp() {}
```

**3. åœ¨ Container åº”ç”¨çš„ App.js æ–‡ä»¶ä¸­é…ç½®è·¯ç”±**

```js
<Router history={history}>
  <Header />
	<Switch>
  <Route path='/auth/signin'>
    <AuthApp setStatus={setStatus} />
  </Route>
	<Route path='/'>
  	<MarketingApp />
  </Route>
	</Switch>
</Router>
```

**4. è§£å†³ç™»å½•é¡µé¢ç‚¹å‡»ä¸¤æ¬¡æ‰æ˜¾ç¤ºçš„ Bug**

å½“ç‚¹å‡»ç™»å½•æŒ‰é’®æ—¶ï¼Œå®¹å™¨åº”ç”¨çš„è·¯ç”±åœ°å€æ˜¯ /auth/signinï¼ŒåŠ è½½ AuthAppï¼Œä½†æ˜¯ AuthApp åœ¨é¦–æ¬¡åŠ è½½æ—¶é»˜è®¤è®¿é—®çš„æ˜¯ /ï¼Œå› ä¸ºåœ¨ä½¿ç”¨ createMemoryHistory åˆ›å»ºè·¯ç”±æ—¶æ²¡æœ‰ä¼ é€’åˆå§‹å‚æ•°ï¼Œå½“å†æ¬¡ç‚¹å‡»ç™»å½•æŒ‰é’®æ—¶ï¼Œå®¹å™¨åº”ç”¨é€šçŸ¥å¾®åº”ç”¨è·¯ç”±å‘ç”Ÿäº†å˜åŒ–ï¼Œå¾®åº”ç”¨åŒæ­¥è·¯ç”±å˜åŒ–ï¼Œæ‰€ä»¥æœ€ç»ˆçœ‹åˆ°äº†ç™»å½•é¡µé¢ã€‚

è§£å†³é—®é¢˜çš„æ ¸å¿ƒç‚¹åœ¨äºå¾®åº”ç”¨åœ¨åˆå§‹åˆ›å»ºè·¯ç”±å¯¹è±¡æ—¶åº”è¯¥æ¥æ”¶ä¸€ä¸ªé»˜è®¤å‚æ•°ï¼Œé»˜è®¤å‚æ•°å°±æ¥è‡ªäºå®¹ å™¨åº”ç”¨ã€‚

```js
// auth/bootstrap.js
function mount(el, { onNavigate, defaultHistory, initialPath }) {
  createMemoryHistory({
    initialEntries: [initialPath]
  })
}
```

```js
// container/src/components/AuthApp.js
mount(ref.current, {
	initialPath: history.location.pathname
})
```

**5. æŒ‰ç…§ä¸Šè¿°æ–¹æ³•ä¿®æ­£ MarketingApp**



### æ‡’åŠ è½½å¾®åº”ç”¨

ç›®å‰æ‰€æœ‰çš„å¾®åº”ç”¨éƒ½ä¼šåœ¨ç”¨æˆ·åˆå§‹è®¿é—®æ—¶è¢«åŠ è½½ï¼Œè¿™æ ·ä¼šå¯¼è‡´åŠ è½½æ—¶é—´è¿‡é•¿ï¼Œè§£å†³åŠæ³•å°±æ˜¯æ‡’åŠ è½½å¾®åº”ç”¨ã€‚

```js
import React, { lazy, Suspense, useState, useEffect } from "react";
import { Router, Route, Switch, Redirect } from "react-router-dom";
import Progress from "./components/Progress";

const MarketingApp = lazy(() => import("./components/MarketingApp"));
const AuthApp = lazy(() => import("./components/AuthApp"));

function App() {
  return (
    <Router history={history}>
      <Suspense fallback={<Progress />}>
        <Switch>
          <Route path='/auth/signin'>
            <AuthApp setStatus={setStatus} />
          </Route>
          <Route path='/'>
            <MarketingApp />
          </Route>
        </Switch>
      </Suspense>
    </Router>
  );
}

export default App;
```



### ç™»å½•çŠ¶æ€

#### è®¾ç½®ç™»å½•çŠ¶æ€

ç”±äºæ¯ä¸ªå¾®åº”ç”¨éƒ½æœ‰å¯èƒ½ç”¨åˆ°ç™»å½•çŠ¶æ€ä»¥åŠè®¾ç½®ç™»å½•çŠ¶æ€çš„æ–¹æ³•ï¼Œæ‰€ä»¥ç™»å½•çŠ¶æ€å’Œè®¾ç½®ç™»å½•çŠ¶æ€çš„æ–¹æ³•éœ€è¦æ”¾ç½®åœ¨å®¹å™¨åº”ç”¨ä¸­ã€‚

```js
// Container/App.js
export default function App() {
  // å­˜å‚¨ç™»å½•çŠ¶æ€
  const [status, setStatus] = useState(false) 
  return <AuthApp setStatus={setStatus} />
}
```

```js
// Container/AuthApp.js
export default function AuthApp({ setStatus }) {
  useEffect(() => {
		mount(ref.current, { setStatus }) 
  }, [])
}
```

```js
// Auth/bootstrap.js
function mount(el, { setStatus }) { 
  ReactDOM.render(<App setStatus={setStatus} />, el)
}
```

```js
// Auth/App.js
export default function App({ setStatus }) {
  return <Signin setStatus={setStatus} />
}
```

```js
// Auth/Signin.js
export default function SignIn({ setStatus }) {
	return <Button onClick={() => setStatus(true)}>ç™»å½•</Button>
}
```

#### ç™»å½•çŠ¶æ€åº”ç”¨

æ ¹æ®ç™»å½•çŠ¶æ€æ›´æ”¹å¤´éƒ¨ç»„ä»¶å³ä¾§çš„æŒ‰é’®æ–‡å­—ï¼Œå¦‚æœæ˜¯**æœªç™»å½•çŠ¶æ€**ï¼Œ**æ˜¾ç¤ºç™»å½•**ï¼Œå¦‚æœæ˜¯**ç™»å½•çŠ¶æ€**ï¼Œæ˜¾ç¤ºé€€å‡ºã€‚ç‚¹å‡»é€€å‡ºæŒ‰é’®å–æ¶ˆç™»å½•çŠ¶æ€ã€‚ å¦‚æœç™»å½•çŠ¶æ€ä¸ºçœŸï¼Œè·³è½¬åˆ° Dashboard åº”ç”¨ã€‚

```js
// Container/App.js
export default function App() {
  const [status, setStatus] = useState(false) 
  // å¦‚æœç™»å½•çŠ¶æ€ä¸ºçœŸï¼Œè·³è½¬åˆ° Dashboard åº”ç”¨ 
  useEffect(() => {
  	if (status) history.push("/dashboard") 
  }, [status])
  return (
    <Router history={history}>
      {/* å°†ç™»å½•çŠ¶æ€å’Œè®¾ç½®ç™»å½•çŠ¶æ€çš„æ–¹æ³•ä¼ é€’åˆ°å¤´éƒ¨ç»„ä»¶ */} 
      <Header status={status} setStatus={setStatus} />
    </Router>
  ) 
}
```

```js
// Container/Header.js
export default function Header({ status, setStatus }) { 
  // å½“ç‚¹å‡»æŒ‰é’®æ—¶å–æ¶ˆç™»å½•çŠ¶æ€
	const onClick = () => {
    if (status && setStatus) setStatus(false)
  }
return <Button 
  to={status ? "/" : "/auth/signin"} 
  onClick={onClick}
  >{status ? "é€€å‡º" : "ç™»å½•"}</Button>
}
```



### Dashboard

#### åˆå§‹åŒ–

**1. æ–°å»º public æ–‡ä»¶å¤¹å¹¶æ‹·è´ index.html æ–‡ä»¶**

```html
<div id="dev-dashboard"></div>
```

**2. æ–°å»º src æ–‡ä»¶å¤¹å¹¶æ‹·è´ index.js å’Œ bootstrap.js**

```js
// bootstrap.js
import { createApp } from "vue"
import Dashboard from "./components/Dashboard.vue"
function mount(el) {
  const app = createApp(Dashboard) 
  app.mount(el)
}
if (process.env.NODE_ENV === "development") {
	const el = document.querySelector("#dev-dashboard") 
  if (el) mount(el)
}
export { mount }
```

**3. æ‹·è´ webpack.config.js æ–‡ä»¶å¹¶åšå¦‚ä¸‹ä¿®æ”¹**

```js
const HtmlWebpackPlugin = require("html-webpack-plugin")
const { VueLoaderPlugin } = require("vue-loader")
const ModuleFederationPlugin = require("webpack/lib/container/ModuleFederationPlugin")
const packageJson = require("./package.json")

module.exports = {
  mode: "development",
  entry: "./src/index.js",
  output: {
    publicPath: "http://localhost:8083/",
    filename: "[name].[contentHash].js"
  },
  resolve: {
    extensions: [".js", ".vue"]
  },
  devServer: {
    port: 8083,
    historyApiFallback: true,
    headers: {
      "Access-Control-Allow-Origin": "*"
    }
  },
  module: {
    rules: [
      {
        test: /\.(png|jpe?g|gif|woff|svg|eot|ttf)$/i,
        use: [
          {
            loader: "file-loader"
          }
        ]
      },
      {
        test: /\.vue$/,
        use: "vue-loader"
      },
      {
        test: /\.scss|\.css$/,
        use: ["vue-style-loader", "style-loader", "css-loader", "sass-loader"]
      },
      {
        test: /\.js$/,
        exclude: /node_modules/,
        use: {
          loader: "babel-loader",
          options: {
            presets: ["@babel/preset-env"],
            plugins: ["@babel/plugin-transform-runtime"]
          }
        }
      }
    ]
  },
  plugins: [
    new ModuleFederationPlugin({
      name: "dashboard",
      filename: "remoteEntry.js",
      exposes: {
        "./DashboardApp": "./src/bootstrap"
      },
      shared: packageJson.dependencies
    }),
    new HtmlWebpackPlugin({
      template: "./public/index.html"
    }),
    new VueLoaderPlugin()
  ]
}
```

**4. ä¿®æ”¹å¯åŠ¨å‘½ä»¤**

```js
"scripts": {
  "start": "webpack serve"
}
```



#### Container åº”ç”¨åŠ è½½ Dashboard

**1. Container é…ç½® ModuleFedaration**

```js
// container/webpack.config.js
remotes: {
	dashboard: "dashboard@http://localhost:8083/remoteEntry.js"
}
```

**2. æ–°å»º DashboardApp ç»„ä»¶**

```js
import React, { useRef, useEffect } from "react"
import { mount } from "dashboard/DashboardApp"
export default function DashboardApp() {
  const ref = useRef()
  useEffect(() => {
		mount(ref.current) 
  }, [])
  return <div ref={ref}></div>
}
```

**3. Container åº”ç”¨æ·»åŠ è·¯ç”±**

```js
const DashboardApp = lazy(() => import("./components/DashboardApp"))
function App () {
  return (
    <Route path="/dashboard">
      <DashboardApp />
		</Route>
) }
```



#### Dashboard è·¯ç”±ä¿æŠ¤

```js
function App () {
  const [status, setStatus] = useState(false)
  useEffect(() => {
		if (status) history.push("/dashboard") 
  }, [status])
	return (
    <Router history={history}>
      <Route path="/dashboard">
        {!status && <Redirect to="/" />}
        <DashboardApp />
      </Route>
		</Router>
	) 
}
```

```js
 // Marketing/Landing.js
<Link to="/dashboard">
  <Button variant="contained" color="primary">
		Dashboard
  </Button>
</Link>
```



# å…¶ä»–å¾®å‰ç«¯åº”ç”¨æ–¹æ¡ˆ

[äº¬ä¸œå¾®å‰ç«¯æ–¹æ¡ˆ](https://cangdu.org/micro-app/)

[qiankun](https://qiankun.umijs.org/zh)

## æŠ€æœ¯æ–‡ç« è¡¥å……

[qiankun å¾®å‰ç«¯æ–¹æ¡ˆé€‚é… HashRouter æ¨¡å¼åŠ TypeScript é¡¹ç›®](https://blog.xiangfa.org/2021/01/qiankun-micro-front-end-solution-adapts-to-hash-router/)
